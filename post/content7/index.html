<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Airflowã®TaskFlowAPIã«ã¤ã„ã¦ | -1.9517320122461623</title><meta name=keywords content="Airflow,Python"><meta name=description content="ä»Šæ›´ã§ã™ãŒã—ã£ã‹ã‚Šèª¿ã¹ã¦ã¿ã¾ã—ãŸ"><meta name=author content="Me"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.447f4924d3ebf89bcf25c7e77c905cb2ee6ea803dacb2c3621646ef4f50d1f86.css integrity="sha256-RH9JJNPr+JvPJcfnfJBcsu5uqAPayyw2IWRu9PUNH4Y=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://github.com/srn221B/srn221B.github.io/assets/60976262/00ebf8b5-eceb-4f87-8e70-df54f431a9b8><link rel=icon type=image/png sizes=16x16 href=https://github.com/srn221B/srn221B.github.io/assets/60976262/00ebf8b5-eceb-4f87-8e70-df54f431a9b8><link rel=icon type=image/png sizes=32x32 href=https://github.com/srn221B/srn221B.github.io/assets/60976262/00ebf8b5-eceb-4f87-8e70-df54f431a9b8><link rel=apple-touch-icon href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><link rel=mask-icon href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Airflowã®TaskFlowAPIã«ã¤ã„ã¦"><meta property="og:description" content="ä»Šæ›´ã§ã™ãŒã—ã£ã‹ã‚Šèª¿ã¹ã¦ã¿ã¾ã—ãŸ"><meta property="og:type" content="article"><meta property="og:url" content="https://467tn.com/post/content7/"><meta property="og:image" content="https://user-images.githubusercontent.com/60976262/191047722-dd7ed9ad-6e00-4b50-8073-24ae9602b8d6.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-01-01T11:30:03+00:00"><meta property="article:modified_time" content="2023-01-01T11:30:03+00:00"><meta property="og:site_name" content="467"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://user-images.githubusercontent.com/60976262/191047722-dd7ed9ad-6e00-4b50-8073-24ae9602b8d6.png"><meta name=twitter:title content="Airflowã®TaskFlowAPIã«ã¤ã„ã¦"><meta name=twitter:description content="ä»Šæ›´ã§ã™ãŒã—ã£ã‹ã‚Šèª¿ã¹ã¦ã¿ã¾ã—ãŸ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://467tn.com/post/"},{"@type":"ListItem","position":3,"name":"Airflowã®TaskFlowAPIã«ã¤ã„ã¦","item":"https://467tn.com/post/content7/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Airflowã®TaskFlowAPIã«ã¤ã„ã¦","name":"Airflowã®TaskFlowAPIã«ã¤ã„ã¦","description":"ä»Šæ›´ã§ã™ãŒã—ã£ã‹ã‚Šèª¿ã¹ã¦ã¿ã¾ã—ãŸ","keywords":["Airflow","Python"],"articleBody":"TaskFlowAPIã¨ã¯ Airflowä¸Šã§ã®Workflowã®æ›¸ãæ–¹ã®ä¸€ã¤ã€‚å¾“æ¥Workflowã®æ›¸ãæ–¹ã¯ã€ŒDAGclassã‚’å®šç¾©ã—ã€OperatoråŒå£«ã‚’ç¹‹ã’ã‚‹æ›¸ãæ–¹(Operatorã‚’ä½¿ç”¨ã—ãŸæ›¸ãæ–¹)ã€ã—ã‹ãªã‹ã£ãŸãŒã€Airflow2.0ã‹ã‚‰æ–°ã—ã„æ›¸ãæ–¹ãŒå°å…¥ã•ã‚ŒãŸã€‚\nåŸºæœ¬çš„ãªæ›¸ãæ–¹ DAGã®æ›¸ãæ–¹ @dagã§Workflowã‚’å®šç¾©ã™ã‚‹é–¢æ•°ã‚’decorateã™ã‚‹ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«DAGã‚’ç™»éŒ²ã™ã‚‹å¿…è¦ãŒãªããªã£ãŸã€‚\n@dag( schedule=None, start_date=pendulum.datetime(2021, 1, 1, tz=\"UTC\"), catchup=False, tags=[\"example\"], ) def tutorial_taskflow_api(): \"\"\" DAG Docs Example \"\"\"  tutorial_taskflow_apiãŒdag_id é–¢æ•°é…ä¸‹ã«æ›¸ã„ã¦ã‚ã‚‹__doc__ãŒDAGã®Doc  Taskã®æ›¸ãæ–¹(PythonOperatorã®ä¾‹) TaskFlowDecoratorã§Taskã®é–¢æ•°ã‚’decorateã™ã‚‹ã€‚\n@task() def extract(): \"\"\" extract doc_md Example \"\"\" data_string = '{\"1001\": 301.27, \"1002\": 433.21, \"1003\": 502.22}' order_data_dict = json.loads(data_string) return order_data_dict  extractãŒtask_id é–¢æ•°é…ä¸‹ã«æ›¸ã„ã¦ã‚ã‚‹__doc__ãŒTaskã®Doc  å¯¾å¿œã—ã¦ã„ã‚‹Operator ä¸Šè¨˜PythonOperatorä»¥å¤–ã«ã‚‚ä»¥ä¸‹ã®OperatorãŒTaskFlowDecoratorã«å¯¾å¿œã—ã¦ã„ã‚‹ã€‚ä¸»ã«ç‹¬è‡ªã®å®Ÿè¡Œç’°å¢ƒã§Pythonã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚ˆã†ãªOperatorãŒç¾åœ¨ã¯å¯¾å¿œã—ã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚\n   Operator TaskFlowDecorator     PythonOperator @task(@task.python)   PythonVirtualenvOperator @task.virtualenv   BranchPythonOperator @task.branch   DockerOperator @task.docker   KubernetesOperator @task.kubernetes   ExternalPythonOperato @task.external_python   SensorOperator @task.sensor    Flowã®æ›¸ãæ–¹ Operatorã‚’ä½¿ç”¨ã—ãŸæ›¸ãæ–¹ã§ã¯ã€ã‚’ä½¿ç”¨ã—ã¦Flowã‚’è¨˜è¿°ã—ã¦ã„ãŸãŒã€Pythonãƒ©ã‚¤ã‚¯ã«é–¢æ•°ã‚’å‘¼ã³å‡ºã™å½¢ã§Flow(ä¾å­˜é–¢ä¿‚)ã‚’æ›¸ãã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚\nä¾‹ãˆã°ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º(extract)ã—ã¦ã€æŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›(transform)ã—ã¦ã€å¤‰æ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰total_order_valueã‚’èª­ã¿è¾¼ã‚€(load)ã‚ˆã†ãªä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ˜ç¤ºçš„ã«å®šç¾©ã§ãã‚‹ã€‚\norder_data = extract() # extract order_summary = transform(order_data) # transform load(order_summary[\"total_order_value\"]) # load ä½•ãŒç•°ãªã‚‹ã®ã‹(TaskFlowAPIã®ãƒ¡ãƒªãƒƒãƒˆ) Operatorã‚’ä½¿ç”¨ã—ãŸæ›¸ãæ–¹ã¨æ¯”ã¹ã€å€‹äººçš„ã«ä»¥ä¸‹ã®ï¼”ç‚¹ãŒãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã‚ã‚‹ã‹ãªã¨æ€ã£ã¦ãŠã‚Šã¾ã™ã€‚\n ã€ŒXcomãŒæŠ½è±¡åŒ–ã•ã‚ŒTaské–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ãŒå®¹æ˜“ã«ãªã£ãŸã€ ã€ŒTaskå…¨ä½“ãŒè¦‹ã‚„ã™ããªã£ãŸã€ ã€ŒTaskã‚’å†åˆ©ç”¨ã§ãã‚‹ã€ ã€Œmultiple_outputsãŒä½¿ãˆã‚‹ã€  XcomãŒæŠ½è±¡åŒ–ã•ã‚ŒTaské–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ãŒå®¹æ˜“ã«ãªã£ãŸ ä»¥å‰ã®æ›¸ãæ–¹ã§ã¯Taské–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ã¯task_instancesã®xcom_pullã‚„xcom_pushãªã©ã‚’è¨˜è¿°ã—ã¦è¡Œã£ã¦ã„ãŸãŒã€XcomãŒæŠ½è±¡åŒ–ã•ã‚ŒãŸãŸã‚Xcomã®è¨˜è¿°ã‚’ã—ãªãã¦ã‚‚è‰¯ããªã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ãŒå®¹æ˜“ã«ãªã£ãŸã€‚\n NOT TaskFlowAPIåˆ©ç”¨  def extract(**kwargs): ti = kwargs[\"ti\"] data_string = '{\"1001\": 301.27, \"1002\": 433.21, \"1003\": 502.22}' ti.xcom_push(\"order_data\", data_string) def transform(**kwargs): ti = kwargs[\"ti\"] extract_data_string = ti.xcom_pull(task_ids=\"extract\", key=\"order_data\") print(extract_data_string) extract_task = PythonOperator( task_id=\"extract\", python_callable=extract, ) transform_task = PythonOperator( task_id=\"transform\", python_callable=transform, ) extract_task  transform_task  TaskFlowAPIåˆ©ç”¨  @task() def extract(): data_string = '{\"1001\": 301.27, \"1002\": 433.21, \"1003\": 502.22}' order_data_dict = json.loads(data_string) return order_data_dict @task() def transform(order_data_dict: dict): print(order_data_dict) order_data = extract() transform(order_data) Taskå…¨ä½“ãŒè¦‹ã‚„ã™ããªã£ãŸ DAGã‚„Taskã®DocãŒdecorateã—ãŸé–¢æ•°ã®__doc__ã‚’è‡ªå‹•çš„ã«å‚ç…§ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§Taskå…¨ä½“ãŒè¦‹ã‚„ã™ããªã£ãŸã€‚Taské–“ã®ä¾å­˜é–¢ä¿‚ã‚‚ã‚ã‹ã‚Šã‚„ã™ããªã£ãŸã€‚\n NOT TaskFlowAPIåˆ©ç”¨  def extract(**kwargs): pass extract_task = PythonOperator( task_id=\"extract\", python_callable=extract, ) extract_task.doc_md = dedent('extract_taskã®doc')  TaskFlowAPIåˆ©ç”¨  @task() def extract(): \"\"\" extract_taskã®doc \"\"\" Taskã‚’å†åˆ©ç”¨ã§ãã‚‹ overrideã¨ã„ã†é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦å†åˆ©ç”¨ã§ãã‚‹ã€‚ã¾ãŸå†åˆ©ç”¨æ™‚ã«task_id,queue,poolã‚’æŒ‡å®šã§ãã‚‹ã€‚\nfrom airflow.decorators import task, dag from datetime import datetime @task def add_task(x, y): print(f\"Task args: x={x}, y={y}\") return x + y @dag(start_date=datetime(2022,1,1)) def mydag(): \"\"\" start - [add_start_0, add_start_1, add_start_2,] \"\"\" start = add_task.override(task_id='start')(1,2) for i in range(3): start  add_task.override(task_id=f'add_start_{i}')(start, i) @dag(start_date=datetime(2022,1,1)) def mydag2(): \"\"\" add_task  ['new_add_task_0', 'new_add_task_1', 'new_add_task_2'] \"\"\" start = add_task(1,2) for i in range(3): start  add_task.override(task_id=f'new_add_task_{i}')(start, i) first_dag = mydag() second_dag = mydag2() multiple_outputsãŒä½¿ãˆã‚‹ 1Taskã§Xcomè¤‡æ•°ã®key/valueã‚’Pushã—ãŸã„æ™‚ã«ã“ã‚Œã¾ã§keyã®åˆ†ã ã‘xcom_pushã‚’ã—ã¦ã„ãŸãŒã€multiple_outputsã‚’ä½¿ãˆã°1è¡Œã§è¤‡æ•°key/valueã‚’Pushã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚Taskã®é–¢æ•°ã®æˆ»ã‚Šå€¤ã«Dictã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã¨TaskFlowDecoratorã«æ¸¡ã™multiple_outputsãŒè‡ªå‹•çš„ã«Trueã«ãªã‚Šã€Dictã‚’å±•é–‹ã—ãŸä¸Šã§Xcomã«key/valueã‚’Pushã—ã¦ãã‚Œã‚‹ã€‚\n NOT TaskFlowAPIåˆ©ç”¨  def identity_dict(**kwargs): ti = kwargs['ti'] ti.xcom_push('x', kwargs['x']) ti.xcom_push('y', kwargs['y'])  TaskFlowAPIåˆ©ç”¨  @task(multiple_outputs=True) def identity_dict(x: int, y: int): return {\"x\": x, \"y\": y} # ä»¥ä¸‹ã®æ›¸ãæ–¹ã§ã‚‚åŒã˜æŒ™å‹• @task def identity_dict(x: int, y: int) - dict[str, int]: return {\"x\": x, \"y\": y} ä¸Šè¨˜ã®å ´åˆã¯æ¬¡ã®key/valueãŒXcomã«Pushã•ã‚Œã‚‹ã€‚\n return_value: {â€œxâ€: x, â€œyâ€: y} x: 1 y: 3  Operatorã¨ã®äº’æ›æ€§ã«ã¤ã„ã¦ TaskFlowAPIã¨Operatorã®ä½µç”¨ã¯å¯èƒ½ @task() def extract_from_file(): order_data_file = \"/tmp/order_data.csv\" order_data_df = pd.read_csv(order_data_file) file_task = FileSensor(task_id='check_file', filepath='/tmp/order_data.csv') order_data = extract_from_file() file_task  order_data  Operator-TaskFlowAPIã¸ã®Xcomã®å—ã‘æ¸¡ã—ã‚‚Operatorã®outputãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’åˆ©ç”¨ã™ã‚Œã°ã§ãã‚‹  @task def task_output(msg): print(f\"Output: {msg}\") @dag(start_date=datetime(2022,1,1)) def mydag2(): bash_task = BashOperator( task_id=\"bash_task\", bash_command='echo \"Here is the message\"') bash_task_output = bash_task.output task_output(bash_task_output) TaskFlowAPIã§ã‚‚Contextã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ Taskã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹Contextã¯æ˜ç¤ºçš„ã«å¼•æ•°ã‚’æ¸¡ã™ã‹(â‘ )ã€kwargsã§ã¨ã‚‹ã‹(â‘¡)ã€get_current_contextã‚’ä½¿ç”¨(â‘¢)ã—ã¦å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚\n#ã€€æ˜ç¤ºçš„ã«å¼•æ•°ã‚’æ¸¡ã™ @task def my_python_callable(ti=None, next_ds=None): pass # kwargsã§ã¨ã‚‹ @task def my_python_callable(**kwargs): ti = kwargs[\"ti\"] next_ds = kwargs[\"next_ds\"] from airflow.operators.python import get_current_context def some_function_in_your_library(): context = get_current_context() ti = context[\"ti\"] @task.kubernetesã‚’è©¦ã—ã¦ã¿ã‚‹ Zennã«ãŠã„ã¦ä»¥å‰æ›¸ã„ãŸè¨˜äº‹https://zenn.dev/467/articles/ca76be579ccf97ã«æ›¸ã„ã¦ã‚ã‚‹Operator(KubernetesPodOperator)ã‚’ä½¿ã£ãŸã‚„ã‚Šæ–¹ã‚’TaskFlowDecorator(@task.kubernetes)ã«å¯¾å¿œã—ã¤ã¤è©¦ã—ã¦ã¿ã¾ã™ã€‚@task.kubernetesã¸æ¸¡ã›ã‚‹Parameterã¯decorators/__init__.pylã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚\nç°¡æ˜“çš„ãªPodã‚’ä½œã£ã¦ã¿ã‚‹  dag  from airflow.decorators import task, dag from airflow.utils.dates import days_ago @task.kubernetes( namespace=\"default\", name=\"hello-pod-work\", image=\"python:3.8-slim-buster\", labels={\"foo\": \"bar\"}, do_xcom_push=False, in_cluster=False) def dry_run_demo(): print('dry_run_test') @dag( default_args={'owner': '467', 'depends_on_past': False}, start_date=days_ago(2), description='KubernetesPodOperatorã‚’è©¦ã™', tags=[\"work\"]) def test_kubernetes_pod_operator_work(): dry_run_demo() logã¨manifestã‚’ç¢ºèªã™ã‚‹ã¨ã‚ã‹ã‚‹ãŒã€ç’°å¢ƒå¤‰æ•° __PYTHON_SCRIPTã¸dry_run_demoé–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’exportã—ã€/tmp/script.pyã¨ã„ã†ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¸æ›¸ãè¾¼ã¿ã€å®Ÿè¡Œã¨ã„ã†ã“ã¨ã‚’ã—ã¦ã„ã‚‹ã€‚\n manifest   env: - name: __PYTHON_SCRIPT value: \"import pickle\\nimport sys\\n\\n\\nif sys.version_info = (3,6):\\n try:\\n \\ from airflow.plugins_manager import integrate_macros_plugins\\n integrate_macros_plugins()\\n \\ except ImportError:\\n \\n pass\\n\\n\\narg_dict = {\\\"args\\\": [], \\\"kwargs\\\": {}}\\n\\n\\n# Script\\ndef dry_run_demo():\\n print('dry_run_test')\\n\\nres = dry_run_demo(*arg_dict[\\\"args\\\"], **arg_dict[\\\"kwargs\\\"])\"  log  [2023-01-03, 13:41:48 JST] {pod_manager.py:237} INFO - + python -c 'import base64, os;x = os.environ[\"__PYTHON_SCRIPT\"];f = open(\"/tmp/script.py\", \"w\"); f.write(x); f.close()' [2023-01-03, 13:41:48 JST] {pod_manager.py:237} INFO - + python /tmp/script.py [2023-01-03, 13:41:48 JST] {pod_manager.py:237} INFO - dry_run_test Secretã‚’mountã—ã¦ã¿ã‚‹  dag  from works import config_storage_apis @task.kubernetes( namespace=\"default\", name=\"hello-pod-work\", image=\"python:3.8-slim-buster\", labels={\"foo\": \"bar\"}, do_xcom_push=False, in_cluster=False, secrets=[ config_storage_apis.secret_file(), config_storage_apis.secret_env(), config_storage_apis.secret_all_keys()],) def dry_run_demo(): import os print(f\"secret_files: {os.listdir(path='/etc/sql_conn')}\") print(f\"secret_env: {os.environ.get('SQL_CONN')}\") print(f\"secret_all_keys: {os.environ.get('sql_alchemy_conn2')}\") @dag( default_args={'owner': '467', 'depends_on_past': False}, start_date=days_ago(2), description='KubernetesPodOperatorã‚’è©¦ã™', tags=[\"work\"]) def test_kubernetes_pod_operator_work(): dry_run_demo()  works.config_storage_apis  from airflow.kubernetes.secret import Secret def secret_file(): return Secret( deploy_type='volume', deploy_target='/etc/sql_conn', secret='airflow-secrets' ) def secret_env(): return Secret( deploy_type='env', deploy_target='SQL_CONN', secret='airflow-secrets', key='sql_alchemy_conn' ) def secret_all_keys(): return Secret( deploy_type='env', deploy_target=None, secret='airflow-secrets-2' )  log  [2023-01-03, 14:20:37 JST] {pod_manager.py:237} INFO - secret_files: ['sql_alchemy_conn', '..data', '..2023_01_03_05_20_34.2294851822'] [2023-01-03, 14:20:37 JST] {pod_manager.py:237} INFO - secret_env: hoge [2023-01-03, 14:20:37 JST] {pod_manager.py:237} INFO - secret_all_keys: hoge2 PersistentVolumeClaim(PVC)ã‚’mountã—ã¦ã¿ã‚‹  dag  from works import config_storage_apis @task.kubernetes( namespace=\"default\", name=\"hello-pod-work\", image=\"python:3.8-slim-buster\", labels={\"foo\": \"bar\"}, do_xcom_push=False, in_cluster=False, volumes=[config_storage_apis.volume()], volume_mounts=[config_storage_apis.volume_mount()],) def dry_run_demo(): import os print(f\"volume_mount: {os.listdir(path='/root/mount_file')}\") @dag( default_args={'owner': '467', 'depends_on_past': False}, start_date=days_ago(2), description='KubernetesPodOperatorã‚’è©¦ã™', tags=[\"work\"]) def test_kubernetes_pod_operator_work(): dry_run_demo()  works.config_storage_apis  from kubernetes.client import models as k8s def volume_mount(): return k8s.V1VolumeMount( mount_path='/root/mount_file', name='test-volume', read_only=True, sub_path=None, sub_path_expr=None, mount_propagation=None ) def volume(): return k8s.V1Volume( name='test-volume', persistent_volume_claim=k8s.V1PersistentVolumeClaimVolumeSource( claim_name='my-pvc'), )  log  [2023-01-03, 16:55:47 JST] {pod_manager.py:237} INFO - volume_mount: ['pv-delay-bind'] Configmapã‚’mountã—ã¦ã¿ã‚‹  dag  from works import config_storage_apis @task.kubernetes( namespace=\"default\", name=\"hello-pod-work\", image=\"python:3.8-slim-buster\", labels={\"foo\": \"bar\"}, do_xcom_push=False, in_cluster=False, env_from=config_storage_apis.configmaps(),) def dry_run_demo(): import os print(f\"key1: {os.environ['key1']}\") print(f\"key2: {os.environ['key2']}\") @dag( default_args={'owner': '467', 'depends_on_past': False}, start_date=days_ago(2), description='KubernetesPodOperatorã‚’è©¦ã™', tags=[\"work\"]) def test_kubernetes_pod_operator_work(): dry_run_demo()  works.config_storage_apis   def configmaps(): return [ k8s.V1EnvFromSource( config_map_ref=k8s.V1ConfigMapEnvSource( name='test-configmap-1') ), k8s.V1EnvFromSource( config_map_ref=k8s.V1ConfigMapEnvSource( name='test-configmap-2') ), ]  log  [2023-01-03, 17:08:32 JST] {pod_manager.py:237} INFO - key1: value1 [2023-01-03, 17:08:32 JST] {pod_manager.py:237} INFO - key2: value2 Podå†…ã«è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹ Operatorã‚’ä½¿ç”¨ã—ãŸæ›¸ãæ–¹ã§ã¯è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹æ–¹æ³•ã¨ã—ã¦full_pod_specãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã¨pod_template_fileãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã—ãŸãŒã€TaskFlowDecoratorã§ã¯full_pod_specãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã¯ç¾åœ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚ãªã®ã§pod_template_fileãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã§è©¦ã—ã¦ã¿ã¾ã™ã€‚\n test.yml  apiVersion: v1 kind: Pod metadata: labels: run: share-pod name: share-pod spec: containers: - image: python:3.7-slim-buster name: container1 - image: python:3.8-slim-buster name: container2 restartPolicy: Always  dag  pod_template_filepath='test.yml' @task.kubernetes( namespace=\"default\", pod_template_file=pod_template_filepath, do_xcom_push=False, in_cluster=False,) def dry_run_demo(): print('hello container!') @dag( default_args={'owner': '467', 'depends_on_past': False}, start_date=days_ago(2), description='KubernetesPodOperatorã‚’è©¦ã™', tags=[\"work\"]) def test_kubernetes_pod_operator_work(): dry_run_demo() name:share-podã¸ã€name:container1,name:container2ã¨ã„ã†ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¦ã„ã‚‹ãŒã€dry_run_demoé–¢æ•°å†…ã®ã‚³ãƒ¼ãƒ‰(printæ–‡)ã¯ä¸€ã¤ã®ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ã—ã‹å®Ÿè¡Œã•ã‚Œãªã„ã€‚ä¸Šè¨˜ã®ä¾‹ã ã¨spec.containersã®1è¦ç´ ç›®ã®ã‚³ãƒ³ãƒ†ãƒŠ(container1)ãŒå„ªå…ˆã•ã‚ŒnameãŒbaseã«å¤‰æ›ã•ã‚ŒãŸå½¢ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚\n manifestã®ä¸€éƒ¨  apiVersion: v1 kind: Pod metadata: name: k8s-airflow-pod-3b69a29a430d46-eddb86a134094187bba374454c6d83f1 namespace: default spec: containers: - args: - -cx - python -c \"import base64, os;x = os.environ[\\\"__PYTHON_SCRIPT\\\"];f = open(\\\"/tmp/script.py\\\", \\\"w\\\"); f.write(x); f.close()\" \u0026\u0026 python /tmp/script.py command: - bash env: - name: __PYTHON_SCRIPT value: \"import pickle\\nimport sys\\n\\n\\nif sys.version_info = (3,6):\\n try:\\n \\ from airflow.plugins_manager import integrate_macros_plugins\\n integrate_macros_plugins()\\n \\ except ImportError:\\n \\n pass\\n\\n\\narg_dict = {\\\"args\\\": [], \\\"kwargs\\\": {}}\\n\\n\\n# Script\\ndef dry_run_demo():\\n print('hello container!')\\n\\nres = dry_run_demo(*arg_dict[\\\"args\\\"], **arg_dict[\\\"kwargs\\\"])\" image: python:3.7-slim-buster name: base - image: python:3.8-slim-buster name: container2  log(airlfow) airflowã®logã«ã¯base(container1)ã®ãƒ­ã‚°ã—ã‹æ®‹ã£ã¦ã„ãªã„  [2023-01-03, 18:42:40 JST] {pod_manager.py:237} INFO - hello container!  log(k8s) k8sä¸Šã§ã¯æ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã€‚  $ k logs k8s-airflow-pod-3b69a29a430d46-eddb86a134094187bba374454c6d83f1 -c base + python -c 'import base64, os;x = os.environ[\"__PYTHON_SCRIPT\"];f = open(\"/tmp/script.py\", \"w\"); f.write(x); f.close()' + python /tmp/script.py $ k logs k8s-airflow-pod-3b69a29a430d46-eddb86a134094187bba374454c6d83f1 -c container2 Xcomã‚’æ‰±ã†  dag  @task.kubernetes( namespace=\"default\", name=\"hello-pod-work\", image=\"python:3.8-slim-buster\", labels={\"foo\": \"bar\"}, do_xcom_push=True, in_cluster=False,) def dry_run_demo(): f = open('/airflow/xcom/return.json', 'w') f.write('[1,2,3,4]') f.close() @task def xcom_output(**kwargs): ti = kwargs[\"ti\"] print(f\"output: {ti.xcom_pull(task_ids='dry_run_demo')}\") @dag( default_args={'owner': '467', 'depends_on_past': False}, start_date=days_ago(2), description='KubernetesPodOperatorã‚’è©¦ã™', tags=[\"work\"]) def test_kubernetes_pod_operator_work(): dry_run_demo()  xcom_output()  log(airflow xcom_output)  [2023-01-03, 19:14:54 JST] {logging_mixin.py:137} INFO - output: [1, 2, 3, 4] å‚è€ƒ  https://airflow.apache.org/docs/apache-airflow/stable/tutorial/taskflow.html  ","wordCount":"938","inLanguage":"en","image":"https://user-images.githubusercontent.com/60976262/191047722-dd7ed9ad-6e00-4b50-8073-24ae9602b8d6.png","datePublished":"2023-01-01T11:30:03Z","dateModified":"2023-01-01T11:30:03Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://467tn.com/post/content7/"},"publisher":{"@type":"Organization","name":"-1.9517320122461623","logo":{"@type":"ImageObject","url":"https://github.com/srn221B/srn221B.github.io/assets/60976262/00ebf8b5-eceb-4f87-8e70-df54f431a9b8"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://467tn.com accesskey=h title="  (Alt + H)"><img src=https://467tn.com/home2.png alt aria-label=logo height=35></a><div class=logo-switches></div></div><ul id=menu><li><a href=https://467tn.com/ title=whoami><span>whoami</span></a></li><li><a href=https://467tn.com/archives/ title=archive><span>archive</span></a></li><li><a href=https://467tn.com/tags/ title=tags><span>tags</span></a></li><li><a href=https://filmarks.com/users/467 title=ğŸ¥filmarks><span>ğŸ¥filmarks</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://booklog.jp/users/467 title=ğŸ“šbooklog><span>ğŸ“šbooklog</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://zenn.dev/467 title="ğŸ—’ zenn"><span>ğŸ—’ zenn</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://s6n.hatenablog.com/ title=ğŸ›«travels><span>ğŸ›«travels</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://467tn.com>Home</a>&nbsp;Â»&nbsp;<a href=https://467tn.com/post/>Posts</a></div><h1 class=post-title style=color:#164b60>Airflowã®TaskFlowAPIã«ã¤ã„ã¦</h1><div class=post-description>ä»Šæ›´ã§ã™ãŒã—ã£ã‹ã‚Šèª¿ã¹ã¦ã¿ã¾ã—ãŸ</div><div class=post-meta><span title="2023-01-01 11:30:03 +0000 +0000">January 1, 2023</span>&nbsp;Â·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/srn221B/blog/tree/master/content/post/content7.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#taskflowapiã¨ã¯>TaskFlowAPIã¨ã¯</a></li><li><a href=#åŸºæœ¬çš„ãªæ›¸ãæ–¹>åŸºæœ¬çš„ãªæ›¸ãæ–¹</a><ul><li><a href=#dagã®æ›¸ãæ–¹>DAGã®æ›¸ãæ–¹</a></li><li><a href=#taskã®æ›¸ãæ–¹pythonoperatorã®ä¾‹>Taskã®æ›¸ãæ–¹(PythonOperatorã®ä¾‹)</a></li><li><a href=#å¯¾å¿œã—ã¦ã„ã‚‹operator>å¯¾å¿œã—ã¦ã„ã‚‹Operator</a></li><li><a href=#flowã®æ›¸ãæ–¹>Flowã®æ›¸ãæ–¹</a></li></ul></li><li><a href=#ä½•ãŒç•°ãªã‚‹ã®ã‹taskflowapiã®ãƒ¡ãƒªãƒƒãƒˆ>ä½•ãŒç•°ãªã‚‹ã®ã‹(TaskFlowAPIã®ãƒ¡ãƒªãƒƒãƒˆ)</a><ul><li><a href=#xcomãŒæŠ½è±¡åŒ–ã•ã‚Œtaské–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ãŒå®¹æ˜“ã«ãªã£ãŸ>XcomãŒæŠ½è±¡åŒ–ã•ã‚ŒTaské–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ãŒå®¹æ˜“ã«ãªã£ãŸ</a></li><li><a href=#taskå…¨ä½“ãŒè¦‹ã‚„ã™ããªã£ãŸ>Taskå…¨ä½“ãŒè¦‹ã‚„ã™ããªã£ãŸ</a></li><li><a href=#taskã‚’å†åˆ©ç”¨ã§ãã‚‹>Taskã‚’å†åˆ©ç”¨ã§ãã‚‹</a></li><li><a href=#multiple_outputsãŒä½¿ãˆã‚‹>multiple_outputsãŒä½¿ãˆã‚‹</a></li></ul></li><li><a href=#operatorã¨ã®äº’æ›æ€§ã«ã¤ã„ã¦>Operatorã¨ã®äº’æ›æ€§ã«ã¤ã„ã¦</a><ul><li><a href=#taskflowapiã¨operatorã®ä½µç”¨ã¯å¯èƒ½>TaskFlowAPIã¨Operatorã®ä½µç”¨ã¯å¯èƒ½</a></li><li><a href=#taskflowapiã§ã‚‚contextã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹>TaskFlowAPIã§ã‚‚Contextã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹</a></li></ul></li><li><a href=#taskkubernetesã‚’è©¦ã—ã¦ã¿ã‚‹>@task.kubernetesã‚’è©¦ã—ã¦ã¿ã‚‹</a><ul><li><a href=#ç°¡æ˜“çš„ãªpodã‚’ä½œã£ã¦ã¿ã‚‹>ç°¡æ˜“çš„ãªPodã‚’ä½œã£ã¦ã¿ã‚‹</a></li><li><a href=#secretã‚’mountã—ã¦ã¿ã‚‹>Secretã‚’mountã—ã¦ã¿ã‚‹</a></li><li><a href=#persistentvolumeclaimpvcã‚’mountã—ã¦ã¿ã‚‹>PersistentVolumeClaim(PVC)ã‚’mountã—ã¦ã¿ã‚‹</a></li><li><a href=#configmapã‚’mountã—ã¦ã¿ã‚‹>Configmapã‚’mountã—ã¦ã¿ã‚‹</a></li><li><a href=#podå†…ã«è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹>Podå†…ã«è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹</a></li><li><a href=#xcomã‚’æ‰±ã†>Xcomã‚’æ‰±ã†</a></li></ul></li><li><a href=#å‚è€ƒ>å‚è€ƒ</a></li></ul></nav></div></details></div><div class=post-content><h2 id=taskflowapiã¨ã¯>TaskFlowAPIã¨ã¯<a hidden class=anchor aria-hidden=true href=#taskflowapiã¨ã¯>#</a></h2><p>Airflowä¸Šã§ã®Workflowã®æ›¸ãæ–¹ã®ä¸€ã¤ã€‚å¾“æ¥Workflowã®æ›¸ãæ–¹ã¯ã€ŒDAGclassã‚’å®šç¾©ã—ã€OperatoråŒå£«ã‚’ç¹‹ã’ã‚‹æ›¸ãæ–¹(Operatorã‚’ä½¿ç”¨ã—ãŸæ›¸ãæ–¹)ã€ã—ã‹ãªã‹ã£ãŸãŒã€Airflow2.0ã‹ã‚‰æ–°ã—ã„æ›¸ãæ–¹ãŒå°å…¥ã•ã‚ŒãŸã€‚</p><h2 id=åŸºæœ¬çš„ãªæ›¸ãæ–¹>åŸºæœ¬çš„ãªæ›¸ãæ–¹<a hidden class=anchor aria-hidden=true href=#åŸºæœ¬çš„ãªæ›¸ãæ–¹>#</a></h2><h3 id=dagã®æ›¸ãæ–¹>DAGã®æ›¸ãæ–¹<a hidden class=anchor aria-hidden=true href=#dagã®æ›¸ãæ–¹>#</a></h3><p><code>@dag</code>ã§Workflowã‚’å®šç¾©ã™ã‚‹é–¢æ•°ã‚’decorateã™ã‚‹ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«DAGã‚’ç™»éŒ²ã™ã‚‹å¿…è¦ãŒãªããªã£ãŸã€‚</p><pre tabindex=0><code>@dag(
    schedule=None,
    start_date=pendulum.datetime(2021, 1, 1, tz=&#34;UTC&#34;),
    catchup=False,
    tags=[&#34;example&#34;],
)
def tutorial_taskflow_api():
   &#34;&#34;&#34; DAG Docs Example
   &#34;&#34;&#34;
</code></pre><ul><li><code>tutorial_taskflow_api</code>ãŒdag_id</li><li>é–¢æ•°é…ä¸‹ã«æ›¸ã„ã¦ã‚ã‚‹__doc__ãŒDAGã®Doc</li></ul><h3 id=taskã®æ›¸ãæ–¹pythonoperatorã®ä¾‹>Taskã®æ›¸ãæ–¹(PythonOperatorã®ä¾‹)<a hidden class=anchor aria-hidden=true href=#taskã®æ›¸ãæ–¹pythonoperatorã®ä¾‹>#</a></h3><p>TaskFlowDecoratorã§Taskã®é–¢æ•°ã‚’decorateã™ã‚‹ã€‚</p><pre tabindex=0><code>@task()
def extract():
    &#34;&#34;&#34; extract doc_md Example
    &#34;&#34;&#34;
    data_string = &#39;{&#34;1001&#34;: 301.27, &#34;1002&#34;: 433.21, &#34;1003&#34;: 502.22}&#39;

    order_data_dict = json.loads(data_string)
    return order_data_dict
</code></pre><ul><li><code>extract</code>ãŒtask_id</li><li>é–¢æ•°é…ä¸‹ã«æ›¸ã„ã¦ã‚ã‚‹__doc__ãŒTaskã®Doc</li></ul><h3 id=å¯¾å¿œã—ã¦ã„ã‚‹operator>å¯¾å¿œã—ã¦ã„ã‚‹Operator<a hidden class=anchor aria-hidden=true href=#å¯¾å¿œã—ã¦ã„ã‚‹operator>#</a></h3><p>ä¸Šè¨˜PythonOperatorä»¥å¤–ã«ã‚‚ä»¥ä¸‹ã®OperatorãŒTaskFlowDecoratorã«å¯¾å¿œã—ã¦ã„ã‚‹ã€‚ä¸»ã«ç‹¬è‡ªã®å®Ÿè¡Œç’°å¢ƒã§Pythonã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚ˆã†ãªOperatorãŒç¾åœ¨ã¯å¯¾å¿œã—ã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚</p><table><thead><tr><th>Operator</th><th>TaskFlowDecorator</th></tr></thead><tbody><tr><td>PythonOperator</td><td>@task(@task.python)</td></tr><tr><td>PythonVirtualenvOperator</td><td>@task.virtualenv</td></tr><tr><td>BranchPythonOperator</td><td>@task.branch</td></tr><tr><td>DockerOperator</td><td>@task.docker</td></tr><tr><td>KubernetesOperator</td><td>@task.kubernetes</td></tr><tr><td>ExternalPythonOperato</td><td>@task.external_python</td></tr><tr><td>SensorOperator</td><td>@task.sensor</td></tr></tbody></table><h3 id=flowã®æ›¸ãæ–¹>Flowã®æ›¸ãæ–¹<a hidden class=anchor aria-hidden=true href=#flowã®æ›¸ãæ–¹>#</a></h3><p>Operatorã‚’ä½¿ç”¨ã—ãŸæ›¸ãæ–¹ã§ã¯ã€<code>>></code>ã‚’ä½¿ç”¨ã—ã¦Flowã‚’è¨˜è¿°ã—ã¦ã„ãŸãŒã€Pythonãƒ©ã‚¤ã‚¯ã«é–¢æ•°ã‚’å‘¼ã³å‡ºã™å½¢ã§Flow(ä¾å­˜é–¢ä¿‚)ã‚’æ›¸ãã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚</p><p>ä¾‹ãˆã°ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º(extract)ã—ã¦ã€æŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›(transform)ã—ã¦ã€å¤‰æ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰<code>total_order_value</code>ã‚’èª­ã¿è¾¼ã‚€(load)ã‚ˆã†ãªä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ˜ç¤ºçš„ã«å®šç¾©ã§ãã‚‹ã€‚</p><pre tabindex=0><code>order_data = extract() # extract
order_summary = transform(order_data) # transform
load(order_summary[&#34;total_order_value&#34;]) # load
</code></pre><h2 id=ä½•ãŒç•°ãªã‚‹ã®ã‹taskflowapiã®ãƒ¡ãƒªãƒƒãƒˆ>ä½•ãŒç•°ãªã‚‹ã®ã‹(TaskFlowAPIã®ãƒ¡ãƒªãƒƒãƒˆ)<a hidden class=anchor aria-hidden=true href=#ä½•ãŒç•°ãªã‚‹ã®ã‹taskflowapiã®ãƒ¡ãƒªãƒƒãƒˆ>#</a></h2><p>Operatorã‚’ä½¿ç”¨ã—ãŸæ›¸ãæ–¹ã¨æ¯”ã¹ã€å€‹äººçš„ã«ä»¥ä¸‹ã®ï¼”ç‚¹ãŒãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã‚ã‚‹ã‹ãªã¨æ€ã£ã¦ãŠã‚Šã¾ã™ã€‚</p><ul><li>ã€ŒXcomãŒæŠ½è±¡åŒ–ã•ã‚ŒTaské–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ãŒå®¹æ˜“ã«ãªã£ãŸã€</li><li>ã€ŒTaskå…¨ä½“ãŒè¦‹ã‚„ã™ããªã£ãŸã€</li><li>ã€ŒTaskã‚’å†åˆ©ç”¨ã§ãã‚‹ã€</li><li>ã€Œmultiple_outputsãŒä½¿ãˆã‚‹ã€</li></ul><h3 id=xcomãŒæŠ½è±¡åŒ–ã•ã‚Œtaské–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ãŒå®¹æ˜“ã«ãªã£ãŸ>XcomãŒæŠ½è±¡åŒ–ã•ã‚ŒTaské–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ãŒå®¹æ˜“ã«ãªã£ãŸ<a hidden class=anchor aria-hidden=true href=#xcomãŒæŠ½è±¡åŒ–ã•ã‚Œtaské–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ãŒå®¹æ˜“ã«ãªã£ãŸ>#</a></h3><p>ä»¥å‰ã®æ›¸ãæ–¹ã§ã¯Taské–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ã¯<a href=https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/models/taskinstance/index.html#module-airflow.models.taskinstance>task_instances</a>ã®xcom_pullã‚„xcom_pushãªã©ã‚’è¨˜è¿°ã—ã¦è¡Œã£ã¦ã„ãŸãŒã€XcomãŒæŠ½è±¡åŒ–ã•ã‚ŒãŸãŸã‚Xcomã®è¨˜è¿°ã‚’ã—ãªãã¦ã‚‚è‰¯ããªã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ãŒå®¹æ˜“ã«ãªã£ãŸã€‚</p><ul><li>NOT TaskFlowAPIåˆ©ç”¨</li></ul><pre tabindex=0><code>def extract(**kwargs):
    ti = kwargs[&#34;ti&#34;]
    data_string = &#39;{&#34;1001&#34;: 301.27, &#34;1002&#34;: 433.21, &#34;1003&#34;: 502.22}&#39;
    ti.xcom_push(&#34;order_data&#34;, data_string)
def transform(**kwargs):
    ti = kwargs[&#34;ti&#34;]
    extract_data_string = ti.xcom_pull(task_ids=&#34;extract&#34;, key=&#34;order_data&#34;)
    print(extract_data_string)
extract_task = PythonOperator(
    task_id=&#34;extract&#34;,
    python_callable=extract,
)
transform_task = PythonOperator(
    task_id=&#34;transform&#34;,
    python_callable=transform,
)
extract_task &gt;&gt; transform_task
</code></pre><ul><li>TaskFlowAPIåˆ©ç”¨</li></ul><pre tabindex=0><code>@task()
def extract():
    data_string = &#39;{&#34;1001&#34;: 301.27, &#34;1002&#34;: 433.21, &#34;1003&#34;: 502.22}&#39;
    order_data_dict = json.loads(data_string)
    return order_data_dict
@task()
def transform(order_data_dict: dict):
    print(order_data_dict)
order_data = extract()
transform(order_data)
</code></pre><h3 id=taskå…¨ä½“ãŒè¦‹ã‚„ã™ããªã£ãŸ>Taskå…¨ä½“ãŒè¦‹ã‚„ã™ããªã£ãŸ<a hidden class=anchor aria-hidden=true href=#taskå…¨ä½“ãŒè¦‹ã‚„ã™ããªã£ãŸ>#</a></h3><p>DAGã‚„Taskã®DocãŒdecorateã—ãŸé–¢æ•°ã®__doc__ã‚’è‡ªå‹•çš„ã«å‚ç…§ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§Taskå…¨ä½“ãŒè¦‹ã‚„ã™ããªã£ãŸã€‚Taské–“ã®ä¾å­˜é–¢ä¿‚ã‚‚ã‚ã‹ã‚Šã‚„ã™ããªã£ãŸã€‚</p><ul><li>NOT TaskFlowAPIåˆ©ç”¨</li></ul><pre tabindex=0><code>def extract(**kwargs):
ã€€ã€€ã€€pass
extract_task = PythonOperator(
  task_id=&#34;extract&#34;,
  python_callable=extract,
)
extract_task.doc_md = dedent(&#39;extract_taskã®doc&#39;)
</code></pre><ul><li>TaskFlowAPIåˆ©ç”¨</li></ul><pre tabindex=0><code>@task()
def extract():
  &#34;&#34;&#34; extract_taskã®doc
  &#34;&#34;&#34;
</code></pre><h3 id=taskã‚’å†åˆ©ç”¨ã§ãã‚‹>Taskã‚’å†åˆ©ç”¨ã§ãã‚‹<a hidden class=anchor aria-hidden=true href=#taskã‚’å†åˆ©ç”¨ã§ãã‚‹>#</a></h3><p><a href=https://github.com/apache/airflow/blob/81cd6c74788bc3182397dd28a4e7db3f21ff2d69/airflow/decorators/base.py#L447>override</a>ã¨ã„ã†é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦å†åˆ©ç”¨ã§ãã‚‹ã€‚ã¾ãŸå†åˆ©ç”¨æ™‚ã«task_id,queue,poolã‚’æŒ‡å®šã§ãã‚‹ã€‚</p><pre tabindex=0><code>from airflow.decorators import task, dag
from datetime import datetime


@task
def add_task(x, y):
    print(f&#34;Task args: x={x}, y={y}&#34;)
    return x + y

@dag(start_date=datetime(2022,1,1))
def mydag():
    &#34;&#34;&#34; start -&gt; [add_start_0, add_start_1, add_start_2,]
    &#34;&#34;&#34;
    start = add_task.override(task_id=&#39;start&#39;)(1,2)
    for i in range(3):
        start &gt;&gt; add_task.override(task_id=f&#39;add_start_{i}&#39;)(start, i)


@dag(start_date=datetime(2022,1,1))
def mydag2():
    &#34;&#34;&#34; add_task &gt;&gt; [&#39;new_add_task_0&#39;, &#39;new_add_task_1&#39;, &#39;new_add_task_2&#39;]
    &#34;&#34;&#34;
    start = add_task(1,2)
    for i in range(3):
        start &gt;&gt; add_task.override(task_id=f&#39;new_add_task_{i}&#39;)(start, i)

first_dag = mydag()
second_dag = mydag2()
</code></pre><h3 id=multiple_outputsãŒä½¿ãˆã‚‹>multiple_outputsãŒä½¿ãˆã‚‹<a hidden class=anchor aria-hidden=true href=#multiple_outputsãŒä½¿ãˆã‚‹>#</a></h3><p>1Taskã§Xcomè¤‡æ•°ã®key/valueã‚’Pushã—ãŸã„æ™‚ã«ã“ã‚Œã¾ã§keyã®åˆ†ã ã‘xcom_pushã‚’ã—ã¦ã„ãŸãŒã€multiple_outputsã‚’ä½¿ãˆã°1è¡Œã§è¤‡æ•°key/valueã‚’Pushã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚Taskã®é–¢æ•°ã®æˆ»ã‚Šå€¤ã«Dictã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã¨TaskFlowDecoratorã«æ¸¡ã™<code>multiple_outputs</code>ãŒè‡ªå‹•çš„ã«Trueã«ãªã‚Šã€Dictã‚’å±•é–‹ã—ãŸä¸Šã§Xcomã«key/valueã‚’Pushã—ã¦ãã‚Œã‚‹ã€‚</p><ul><li>NOT TaskFlowAPIåˆ©ç”¨</li></ul><pre tabindex=0><code>def identity_dict(**kwargs):
    ti = kwargs[&#39;ti&#39;]
    ti.xcom_push(&#39;x&#39;, kwargs[&#39;x&#39;])
    ti.xcom_push(&#39;y&#39;, kwargs[&#39;y&#39;])
</code></pre><ul><li>TaskFlowAPIåˆ©ç”¨</li></ul><pre tabindex=0><code>@task(multiple_outputs=True)
def identity_dict(x: int, y: int):
    return {&#34;x&#34;: x, &#34;y&#34;: y}
# ä»¥ä¸‹ã®æ›¸ãæ–¹ã§ã‚‚åŒã˜æŒ™å‹•
@task
def identity_dict(x: int, y: int) -&gt; dict[str, int]:
    return {&#34;x&#34;: x, &#34;y&#34;: y}
</code></pre><p>ä¸Šè¨˜ã®å ´åˆã¯æ¬¡ã®key/valueãŒXcomã«Pushã•ã‚Œã‚‹ã€‚</p><ul><li>return_value: {&ldquo;x&rdquo;: x, &ldquo;y&rdquo;: y}</li><li>x: 1</li><li>y: 3</li></ul><h2 id=operatorã¨ã®äº’æ›æ€§ã«ã¤ã„ã¦>Operatorã¨ã®äº’æ›æ€§ã«ã¤ã„ã¦<a hidden class=anchor aria-hidden=true href=#operatorã¨ã®äº’æ›æ€§ã«ã¤ã„ã¦>#</a></h2><h3 id=taskflowapiã¨operatorã®ä½µç”¨ã¯å¯èƒ½>TaskFlowAPIã¨Operatorã®ä½µç”¨ã¯å¯èƒ½<a hidden class=anchor aria-hidden=true href=#taskflowapiã¨operatorã®ä½µç”¨ã¯å¯èƒ½>#</a></h3><pre tabindex=0><code>@task()
def extract_from_file():
   order_data_file = &#34;/tmp/order_data.csv&#34;
   order_data_df = pd.read_csv(order_data_file)
file_task = FileSensor(task_id=&#39;check_file&#39;, filepath=&#39;/tmp/order_data.csv&#39;)
order_data = extract_from_file()
file_task &gt;&gt; order_data
</code></pre><ul><li>Operator->TaskFlowAPIã¸ã®Xcomã®å—ã‘æ¸¡ã—ã‚‚Operatorã®<code>output</code>ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’åˆ©ç”¨ã™ã‚Œã°ã§ãã‚‹</li></ul><pre tabindex=0><code>@task
def task_output(msg):
    print(f&#34;Output: {msg}&#34;)

@dag(start_date=datetime(2022,1,1))
def mydag2():
    bash_task = BashOperator(
        task_id=&#34;bash_task&#34;,
        bash_command=&#39;echo &#34;Here is the message&#34;&#39;)
    bash_task_output = bash_task.output
    task_output(bash_task_output)
</code></pre><h3 id=taskflowapiã§ã‚‚contextã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹>TaskFlowAPIã§ã‚‚Contextã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹<a hidden class=anchor aria-hidden=true href=#taskflowapiã§ã‚‚contextã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹>#</a></h3><p>Taskã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹<a href=https://github.com/apache/airflow/blob/8a15557f6fe73feab0e49f97b295160820ad7cfd/airflow/utils/context.py#L158>Context</a>ã¯æ˜ç¤ºçš„ã«å¼•æ•°ã‚’æ¸¡ã™ã‹(â‘ )ã€kwargsã§ã¨ã‚‹ã‹(â‘¡)ã€get_current_contextã‚’ä½¿ç”¨(â‘¢)ã—ã¦å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚</p><pre tabindex=0><code>#ã€€æ˜ç¤ºçš„ã«å¼•æ•°ã‚’æ¸¡ã™
@task
def my_python_callable(ti=None, next_ds=None):
    pass
# kwargsã§ã¨ã‚‹
@task
def my_python_callable(**kwargs):
    ti = kwargs[&#34;ti&#34;]
    next_ds = kwargs[&#34;next_ds&#34;]

from airflow.operators.python import get_current_context
def some_function_in_your_library():
    context = get_current_context()
    ti = context[&#34;ti&#34;]
</code></pre><h2 id=taskkubernetesã‚’è©¦ã—ã¦ã¿ã‚‹>@task.kubernetesã‚’è©¦ã—ã¦ã¿ã‚‹<a hidden class=anchor aria-hidden=true href=#taskkubernetesã‚’è©¦ã—ã¦ã¿ã‚‹>#</a></h2><p>Zennã«ãŠã„ã¦ä»¥å‰æ›¸ã„ãŸè¨˜äº‹<a href=https://zenn.dev/467/articles/ca76be579ccf97>https://zenn.dev/467/articles/ca76be579ccf97</a>ã«æ›¸ã„ã¦ã‚ã‚‹Operator(KubernetesPodOperator)ã‚’ä½¿ã£ãŸã‚„ã‚Šæ–¹ã‚’TaskFlowDecorator(@task.kubernetes)ã«å¯¾å¿œã—ã¤ã¤è©¦ã—ã¦ã¿ã¾ã™ã€‚@task.kubernetesã¸æ¸¡ã›ã‚‹Parameterã¯<a href=https://github.com/apache/airflow/blob/5246c009c557b4f6bdf1cd62bf9b89a2da63f630/airflow/decorators/__init__.pyi#L300><code>decorators/__init__.pyl</code></a>ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚</p><h3 id=ç°¡æ˜“çš„ãªpodã‚’ä½œã£ã¦ã¿ã‚‹>ç°¡æ˜“çš„ãªPodã‚’ä½œã£ã¦ã¿ã‚‹<a hidden class=anchor aria-hidden=true href=#ç°¡æ˜“çš„ãªpodã‚’ä½œã£ã¦ã¿ã‚‹>#</a></h3><ul><li>dag</li></ul><pre tabindex=0><code>from airflow.decorators import task, dag
from airflow.utils.dates import days_ago

@task.kubernetes(
    namespace=&#34;default&#34;, name=&#34;hello-pod-work&#34;,
    image=&#34;python:3.8-slim-buster&#34;, labels={&#34;foo&#34;: &#34;bar&#34;}, do_xcom_push=False, in_cluster=False)
def dry_run_demo():
    print(&#39;dry_run_test&#39;)

@dag(
    default_args={&#39;owner&#39;: &#39;467&#39;, &#39;depends_on_past&#39;: False}, start_date=days_ago(2),
    description=&#39;KubernetesPodOperatorã‚’è©¦ã™&#39;, tags=[&#34;work&#34;])
def test_kubernetes_pod_operator_work():
    dry_run_demo()
</code></pre><p>logã¨manifestã‚’ç¢ºèªã™ã‚‹ã¨ã‚ã‹ã‚‹ãŒã€ç’°å¢ƒå¤‰æ•°<code> __PYTHON_SCRIPT</code>ã¸dry_run_demoé–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’exportã—ã€<code>/tmp/script.py</code>ã¨ã„ã†ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¸æ›¸ãè¾¼ã¿ã€å®Ÿè¡Œã¨ã„ã†ã“ã¨ã‚’ã—ã¦ã„ã‚‹ã€‚</p><ul><li>manifest</li></ul><pre tabindex=0><code>    env:
    - name: __PYTHON_SCRIPT
      value: &#34;import pickle\nimport sys\n\n\nif sys.version_info &gt;= (3,6):\n    try:\n
        \       from airflow.plugins_manager import integrate_macros_plugins\n        integrate_macros_plugins()\n
        \   except ImportError:\n        \n        pass\n\n\narg_dict = {\&#34;args\&#34;:
        [], \&#34;kwargs\&#34;: {}}\n\n\n# Script\ndef dry_run_demo():\n    print(&#39;dry_run_test&#39;)\n\nres = dry_run_demo(*arg_dict[\&#34;args\&#34;],
        **arg_dict[\&#34;kwargs\&#34;])&#34;
</code></pre><ul><li>log</li></ul><pre tabindex=0><code>[2023-01-03, 13:41:48 JST] {pod_manager.py:237} INFO - + python -c &#39;import base64, os;x = os.environ[&#34;__PYTHON_SCRIPT&#34;];f = open(&#34;/tmp/script.py&#34;, &#34;w&#34;); f.write(x); f.close()&#39;
[2023-01-03, 13:41:48 JST] {pod_manager.py:237} INFO - + python /tmp/script.py
[2023-01-03, 13:41:48 JST] {pod_manager.py:237} INFO - dry_run_test
</code></pre><h3 id=secretã‚’mountã—ã¦ã¿ã‚‹>Secretã‚’mountã—ã¦ã¿ã‚‹<a hidden class=anchor aria-hidden=true href=#secretã‚’mountã—ã¦ã¿ã‚‹>#</a></h3><ul><li>dag</li></ul><pre tabindex=0><code>from works import config_storage_apis

@task.kubernetes(
    namespace=&#34;default&#34;, name=&#34;hello-pod-work&#34;, image=&#34;python:3.8-slim-buster&#34;,
    labels={&#34;foo&#34;: &#34;bar&#34;}, do_xcom_push=False, in_cluster=False,
    secrets=[
        config_storage_apis.secret_file(),
        config_storage_apis.secret_env(),
        config_storage_apis.secret_all_keys()],)
def dry_run_demo():
    import os
    print(f&#34;secret_files: {os.listdir(path=&#39;/etc/sql_conn&#39;)}&#34;)
    print(f&#34;secret_env: {os.environ.get(&#39;SQL_CONN&#39;)}&#34;)
    print(f&#34;secret_all_keys: {os.environ.get(&#39;sql_alchemy_conn2&#39;)}&#34;)

@dag(
    default_args={&#39;owner&#39;: &#39;467&#39;, &#39;depends_on_past&#39;: False}, start_date=days_ago(2),
    description=&#39;KubernetesPodOperatorã‚’è©¦ã™&#39;, tags=[&#34;work&#34;])
def test_kubernetes_pod_operator_work():
    dry_run_demo()
</code></pre><ul><li>works.config_storage_apis</li></ul><pre tabindex=0><code>from airflow.kubernetes.secret import Secret

def secret_file():
    return Secret(
        deploy_type=&#39;volume&#39;, deploy_target=&#39;/etc/sql_conn&#39;,
        secret=&#39;airflow-secrets&#39;
        )

def secret_env():
    return Secret(
        deploy_type=&#39;env&#39;, deploy_target=&#39;SQL_CONN&#39;,
        secret=&#39;airflow-secrets&#39;, key=&#39;sql_alchemy_conn&#39;
	)

def secret_all_keys():
    return Secret(
        deploy_type=&#39;env&#39;, deploy_target=None,
        secret=&#39;airflow-secrets-2&#39;
	)
</code></pre><ul><li>log</li></ul><pre tabindex=0><code>[2023-01-03, 14:20:37 JST] {pod_manager.py:237} INFO - secret_files: [&#39;sql_alchemy_conn&#39;, &#39;..data&#39;, &#39;..2023_01_03_05_20_34.2294851822&#39;]
[2023-01-03, 14:20:37 JST] {pod_manager.py:237} INFO - secret_env: hoge
[2023-01-03, 14:20:37 JST] {pod_manager.py:237} INFO - secret_all_keys: hoge2
</code></pre><h3 id=persistentvolumeclaimpvcã‚’mountã—ã¦ã¿ã‚‹>PersistentVolumeClaim(PVC)ã‚’mountã—ã¦ã¿ã‚‹<a hidden class=anchor aria-hidden=true href=#persistentvolumeclaimpvcã‚’mountã—ã¦ã¿ã‚‹>#</a></h3><ul><li>dag</li></ul><pre tabindex=0><code>from works import config_storage_apis

@task.kubernetes(
    namespace=&#34;default&#34;, name=&#34;hello-pod-work&#34;, image=&#34;python:3.8-slim-buster&#34;,
    labels={&#34;foo&#34;: &#34;bar&#34;}, do_xcom_push=False, in_cluster=False,
    volumes=[config_storage_apis.volume()],
    volume_mounts=[config_storage_apis.volume_mount()],)
def dry_run_demo():
    import os
    print(f&#34;volume_mount: {os.listdir(path=&#39;/root/mount_file&#39;)}&#34;)

@dag(
    default_args={&#39;owner&#39;: &#39;467&#39;, &#39;depends_on_past&#39;: False}, start_date=days_ago(2),
    description=&#39;KubernetesPodOperatorã‚’è©¦ã™&#39;, tags=[&#34;work&#34;])
def test_kubernetes_pod_operator_work():
    dry_run_demo()
</code></pre><ul><li>works.config_storage_apis</li></ul><pre tabindex=0><code>from kubernetes.client import models as k8s

def volume_mount():
    return k8s.V1VolumeMount(
        mount_path=&#39;/root/mount_file&#39;, name=&#39;test-volume&#39;,
        read_only=True, sub_path=None, sub_path_expr=None,
        mount_propagation=None
        )

def volume():
    return k8s.V1Volume(
        name=&#39;test-volume&#39;,
        persistent_volume_claim=k8s.V1PersistentVolumeClaimVolumeSource(
            claim_name=&#39;my-pvc&#39;),
        )
</code></pre><ul><li>log</li></ul><pre tabindex=0><code>[2023-01-03, 16:55:47 JST] {pod_manager.py:237} INFO - volume_mount: [&#39;pv-delay-bind&#39;]
</code></pre><h3 id=configmapã‚’mountã—ã¦ã¿ã‚‹>Configmapã‚’mountã—ã¦ã¿ã‚‹<a hidden class=anchor aria-hidden=true href=#configmapã‚’mountã—ã¦ã¿ã‚‹>#</a></h3><ul><li>dag</li></ul><pre tabindex=0><code>from works import config_storage_apis

@task.kubernetes(
    namespace=&#34;default&#34;, name=&#34;hello-pod-work&#34;, image=&#34;python:3.8-slim-buster&#34;,
    labels={&#34;foo&#34;: &#34;bar&#34;}, do_xcom_push=False, in_cluster=False,
    env_from=config_storage_apis.configmaps(),)
def dry_run_demo():
    import os
    print(f&#34;key1: {os.environ[&#39;key1&#39;]}&#34;)
    print(f&#34;key2: {os.environ[&#39;key2&#39;]}&#34;)

@dag(
    default_args={&#39;owner&#39;: &#39;467&#39;, &#39;depends_on_past&#39;: False}, start_date=days_ago(2),
    description=&#39;KubernetesPodOperatorã‚’è©¦ã™&#39;, tags=[&#34;work&#34;])
def test_kubernetes_pod_operator_work():
    dry_run_demo()
</code></pre><ul><li>works.config_storage_apis</li></ul><pre tabindex=0><code>
def configmaps():
    return [
        k8s.V1EnvFromSource(
		config_map_ref=k8s.V1ConfigMapEnvSource(
			name=&#39;test-configmap-1&#39;)
		),
        k8s.V1EnvFromSource(
		config_map_ref=k8s.V1ConfigMapEnvSource(
			name=&#39;test-configmap-2&#39;)
		),
        ]
</code></pre><ul><li>log</li></ul><pre tabindex=0><code>[2023-01-03, 17:08:32 JST] {pod_manager.py:237} INFO - key1: value1
[2023-01-03, 17:08:32 JST] {pod_manager.py:237} INFO - key2: value2
</code></pre><h3 id=podå†…ã«è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹>Podå†…ã«è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹<a hidden class=anchor aria-hidden=true href=#podå†…ã«è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹>#</a></h3><p>Operatorã‚’ä½¿ç”¨ã—ãŸæ›¸ãæ–¹ã§ã¯è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹æ–¹æ³•ã¨ã—ã¦<code>full_pod_spec</code>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã¨<code>pod_template_file</code>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã—ãŸãŒã€TaskFlowDecoratorã§ã¯<code>full_pod_spec</code>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã¯ç¾åœ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚ãªã®ã§<code>pod_template_file</code>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã§è©¦ã—ã¦ã¿ã¾ã™ã€‚</p><ul><li>test.yml</li></ul><pre tabindex=0><code>apiVersion: v1
kind: Pod
metadata:
  labels:
    run: share-pod
  name: share-pod
spec:
  containers:
  - image: python:3.7-slim-buster
    name: container1
  - image: python:3.8-slim-buster
    name: container2
  restartPolicy: Always
</code></pre><ul><li>dag</li></ul><pre tabindex=0><code>pod_template_filepath=&#39;test.yml&#39;

@task.kubernetes(
    namespace=&#34;default&#34;, pod_template_file=pod_template_filepath,
    do_xcom_push=False, in_cluster=False,)
def dry_run_demo():
    print(&#39;hello container!&#39;)

@dag(
    default_args={&#39;owner&#39;: &#39;467&#39;, &#39;depends_on_past&#39;: False}, start_date=days_ago(2),
    description=&#39;KubernetesPodOperatorã‚’è©¦ã™&#39;, tags=[&#34;work&#34;])
def test_kubernetes_pod_operator_work():
    dry_run_demo()
</code></pre><p>name:share-podã¸ã€name:container1,name:container2ã¨ã„ã†ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¦ã„ã‚‹ãŒã€dry_run_demoé–¢æ•°å†…ã®ã‚³ãƒ¼ãƒ‰(printæ–‡)ã¯ä¸€ã¤ã®ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ã—ã‹å®Ÿè¡Œã•ã‚Œãªã„ã€‚ä¸Šè¨˜ã®ä¾‹ã ã¨spec.containersã®1è¦ç´ ç›®ã®ã‚³ãƒ³ãƒ†ãƒŠ(container1)ãŒå„ªå…ˆã•ã‚ŒnameãŒ<code>base</code>ã«å¤‰æ›ã•ã‚ŒãŸå½¢ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚</p><ul><li>manifestã®ä¸€éƒ¨</li></ul><pre tabindex=0><code>apiVersion: v1
kind: Pod
metadata:
  name: k8s-airflow-pod-3b69a29a430d46-eddb86a134094187bba374454c6d83f1
  namespace: default
spec:
  containers:
  - args:
    - -cx
    - python -c &#34;import base64, os;x = os.environ[\&#34;__PYTHON_SCRIPT\&#34;];f = open(\&#34;/tmp/script.py\&#34;,
      \&#34;w\&#34;); f.write(x); f.close()&#34; &amp;&amp; python /tmp/script.py
    command:
    - bash
    env:
    - name: __PYTHON_SCRIPT
      value: &#34;import pickle\nimport sys\n\n\nif sys.version_info &gt;= (3,6):\n    try:\n
        \       from airflow.plugins_manager import integrate_macros_plugins\n        integrate_macros_plugins()\n
        \   except ImportError:\n        \n        pass\n\n\narg_dict = {\&#34;args\&#34;:
        [], \&#34;kwargs\&#34;: {}}\n\n\n# Script\ndef dry_run_demo():\n    print(&#39;hello container!&#39;)\n\nres = dry_run_demo(*arg_dict[\&#34;args\&#34;],
        **arg_dict[\&#34;kwargs\&#34;])&#34;
    image: python:3.7-slim-buster
    name: base
  - image: python:3.8-slim-buster
    name: container2
</code></pre><ul><li>log(airlfow)
airflowã®logã«ã¯base(container1)ã®ãƒ­ã‚°ã—ã‹æ®‹ã£ã¦ã„ãªã„</li></ul><pre tabindex=0><code>[2023-01-03, 18:42:40 JST] {pod_manager.py:237} INFO - hello container!
</code></pre><ul><li>log(k8s)
k8sä¸Šã§ã¯æ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã€‚</li></ul><pre tabindex=0><code>$ k logs k8s-airflow-pod-3b69a29a430d46-eddb86a134094187bba374454c6d83f1  -c base
+ python -c &#39;import base64, os;x = os.environ[&#34;__PYTHON_SCRIPT&#34;];f = open(&#34;/tmp/script.py&#34;, &#34;w&#34;); f.write(x); f.close()&#39;
+ python /tmp/script.py
$ k logs k8s-airflow-pod-3b69a29a430d46-eddb86a134094187bba374454c6d83f1  -c container2
</code></pre><h3 id=xcomã‚’æ‰±ã†>Xcomã‚’æ‰±ã†<a hidden class=anchor aria-hidden=true href=#xcomã‚’æ‰±ã†>#</a></h3><ul><li>dag</li></ul><pre tabindex=0><code>@task.kubernetes(
    namespace=&#34;default&#34;, name=&#34;hello-pod-work&#34;, image=&#34;python:3.8-slim-buster&#34;,
    labels={&#34;foo&#34;: &#34;bar&#34;}, do_xcom_push=True, in_cluster=False,)
def dry_run_demo():
    f = open(&#39;/airflow/xcom/return.json&#39;, &#39;w&#39;)
    f.write(&#39;[1,2,3,4]&#39;)
    f.close()

@task
def xcom_output(**kwargs):
    ti = kwargs[&#34;ti&#34;]
    print(f&#34;output: {ti.xcom_pull(task_ids=&#39;dry_run_demo&#39;)}&#34;)

@dag(
    default_args={&#39;owner&#39;: &#39;467&#39;, &#39;depends_on_past&#39;: False}, start_date=days_ago(2),
    description=&#39;KubernetesPodOperatorã‚’è©¦ã™&#39;, tags=[&#34;work&#34;])
def test_kubernetes_pod_operator_work():
    dry_run_demo() &gt;&gt; xcom_output()
</code></pre><ul><li>log(airflow xcom_output)</li></ul><pre tabindex=0><code>[2023-01-03, 19:14:54 JST] {logging_mixin.py:137} INFO - output: [1, 2, 3, 4]
</code></pre><h2 id=å‚è€ƒ>å‚è€ƒ<a hidden class=anchor aria-hidden=true href=#å‚è€ƒ>#</a></h2><ul><li><a href=https://airflow.apache.org/docs/apache-airflow/stable/tutorial/taskflow.html>https://airflow.apache.org/docs/apache-airflow/stable/tutorial/taskflow.html</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://467tn.com/tags/airflow/>Airflow</a></li><li><a href=https://467tn.com/tags/python/>Python</a></li></ul><nav class=paginav><a class=prev href=https://467tn.com/post/content8/><span class=title>Â« Prev</span><br><span>Airflowã®Pluginsã«ã¤ã„ã¦</span></a>
<a class=next href=https://467tn.com/post/content6/><span class=title>Next Â»</span><br><span>Great Expectationsã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ãŸ</span></a></nav><br><hr><br><h3>Shares</h3><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Airflowã®TaskFlowAPIã«ã¤ã„ã¦ on twitter" href="https://twitter.com/intent/tweet/?text=Airflow%e3%81%aeTaskFlowAPI%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6&url=https%3a%2f%2f467tn.com%2fpost%2fcontent7%2f&hashtags=Airflow%2cPython"><svg viewBox="0 0 512 512" height="30" width="30"><defs><style>.fill{fill:#3aa6b9}</style></defs><path class="fill" d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a></div></footer><h3>Comments</h3><script src=https://giscus.app/client.js data-repo=srn221B/blog data-repo-id=R_kgDOIBf-Xg data-category=Comments data-category-id=DIC_kwDOIBf-Xs4CTe7o data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=https://giscus.app/themes/custom_example.css crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2023 <a href=https://467tn.com>-1.9517320122461623</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerHTML="copy";function s(){e.innerHTML="copied!",setTimeout(()=>{e.innerHTML="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>