<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AirflowのPluginsについて | 467tn.com</title><meta name=keywords content="Airflow,Python"><meta name=description content="カスタマイズ機能についてです"><meta name=author content="Me"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.b524e4b6d6a6efc25a7ca6b852c6483acb761f26eaea8f43a943a7adaf3dec55.css integrity="sha256-tSTkttam78JafKa4UsZIOst2Hybq6o9DqUOnra897FU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><link rel=icon type=image/png sizes=16x16 href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><link rel=icon type=image/png sizes=32x32 href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><link rel=apple-touch-icon href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><link rel=mask-icon href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="AirflowのPluginsについて"><meta property="og:description" content="カスタマイズ機能についてです"><meta property="og:type" content="article"><meta property="og:url" content="https://467tn.com/post/content8/"><meta property="og:image" content="https://user-images.githubusercontent.com/60976262/191047722-dd7ed9ad-6e00-4b50-8073-24ae9602b8d6.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-01-04T11:30:03+00:00"><meta property="article:modified_time" content="2023-01-04T11:30:03+00:00"><meta property="og:site_name" content="467"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://user-images.githubusercontent.com/60976262/191047722-dd7ed9ad-6e00-4b50-8073-24ae9602b8d6.png"><meta name=twitter:title content="AirflowのPluginsについて"><meta name=twitter:description content="カスタマイズ機能についてです"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://467tn.com/post/"},{"@type":"ListItem","position":3,"name":"AirflowのPluginsについて","item":"https://467tn.com/post/content8/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AirflowのPluginsについて","name":"AirflowのPluginsについて","description":"カスタマイズ機能についてです","keywords":["Airflow","Python"],"articleBody":"AirflowPluginsとは Airflowをカスタマイズするために追加できるPlugin。\nどんな時にAirflowPluginsを使うのか 例えば以下のようなときにAirflowPluginsを使う。\n AirflowのメタデータのDBのコンテンツを表示するViewを作成したいとき。 指定された時間内において任意数のDAGが失敗時にAirflowの機能を監視しカスタムアラートを送信するアプリケーションを作成したいとき。 外部データツールのファイルやログに動的にリンクする詳細ビューをUIに表示したいとき。  新規Plugin作成方法 「plugins_folder」へPythonファイルを用意し、Pythonファイル内でairflow.plugins_manager.AirflowPluginを拡張するクラスを定義すれば新規Pluginを作成できる。\n Pythonファイルの例  定義したAirflowPluginクラスには以下を実装する。  name:propertyにPlugin名 on_load:functionにPluginのロード時に実行してほしい処理 そのほかPluginに追加したいComponent(Pluginの機能)について列挙      from airflow.plugins_manager import AirflowPlugin class MyAirflowPlugin(AirflowPlugin): name = \"empty\" def on_load(cls, *args, **kwargs): pass # そのほかPluginに追加したいComponentについて列挙していく。 上記場合、Plugin名が「empty」であるPluginを作成している。\n 「plugins_folder」の確認の仕方  ちなみに「plugins_folder」はどこで確認できるのかというのだが、「コマンドを利用する」か「cfgファイルを見る」の2通りで確認できる。 基本的にデフォルトでは$AIRFLOW_HOME/pluginsになっているはず。    # コマンドを利用する $ airflow info | grep plugins_folder plugins_folder | xxx # cfgファイルを見る $ cat airflow.cfg | grep plugins_folder plugins_folder = xxxx Plugin確認方法 現在追加されているPluginは何か、Pluginに定義されてあるComponentは何かを確認する方法だが、「UIから確認する方法」と「CLIを利用して確認する方法」がある。WebServerを再起動しなくてもすぐに反映されるのは後者の方法。\n 「UIから確認する方法」  UIのAdmin-Pluginsを使用する。     「CLIを利用して確認する方法」  airflow pluginsを実行する。    $ airflow plugins name | source | appbuilder_views | macros ================+=============================+=============================================================================================+====================== my_plugins_poyo | $PLUGINS_FOLDER/__init__.py | {'name': 'Test View', 'category': 'Test Plugin', 'view': '__init__.TestAppBuilderBaseView'} | __init__.plugin_macro どんなComponentをPluginに追加することができるのか 例えば以下のようなComponentが現在ある。種類としてUIへの機能追加からScheduling、DAG作成する上での機能追加などなどがある。詳細についてはドキュメントを確認すると良い。\n   No Component About     1 hooks 独自のHookを作成する   2 macros カスタムmacroを作成する   3 flask_blueprints AirflowのFlaskにflask.BluePrint製のページを作成する   4 appbuilder_views AirflowのFlaskにflask_appbuilder.BaseView製のページを作成する   5 appbuilder_menu_items Airflow UIのメニューにセクションとリンクを作成する   6 global_operator_extra_links 全ての種類のOperatorにLinkを作成する   7 operator_extra_links 任意の種類のOperatorにLinkを作成する   8 timetables CRONでは表現できないスケジュールを作成する    そのほか「executorを使用してCustomExecutorを作成する」「listenerを使用してイベント検知を作成する」などできそう。\n今回は上記のComponentのみ順に試してみます。\n 1.hooksを使用して独自のHookを作成する。 AirflowのHookとは 外部システムとのインタフェースの役割をしてくれるようなもの。例えば以下のように書いて一貫したメソッドを提供することを意図としてある。\npg_hook = PostgresHook.get_hook(conn_id) pg_hook.copy_exper() 詳細：https://airflow.apache.org/docs/apache-airflow/stable/concepts/connections.html\nplugins_folder配下のファイル 今回は次のようなファイル構造で新規独自のHookを作成していきます。\n. ├── __init__.py　# pluginについて定義 ├── hooks │ ├── __init__.py │ └── airflow_hook_template.py # Hookについて定義  __init__.py  from __future__ import division, absolute_import, print_function import hooks from airflow.plugins_manager import AirflowPlugin class MyPlugins(AirflowPlugin): name = \"my_plugins_poyo\" hooks = [hooks.PluginHook]  hooks/__init__.py  from hooks.airflow_hook_template import PluginHook __all__ = ['PluginHook']  hooks/airflow_hook_template.py  airflow.hooks.base.BaseHookを拡張して書く。    from airflow.hooks.base import BaseHook class PluginHook(BaseHook): pass 上記の場合、特に何もしないHook。\n作成を反映させる。 webserverの再起動が必要。\ndagのファイルからimportしてみる plugins_folderは環境変数PYTHONPATHとして自動的にbuildされている(https://airflow.apache.org/docs/apache-airflow/stable/modules_management.html#built-in-pythonpath-entries-in-airflow)ので,直接plugins_folder配下のディレクトリを指定する形でimportできる。UIからDAGを確認するなどをしてimportErrorが出ていなければ正常に動作している。\n dagのファイル  from hooks.airflow_hook_template import PluginHook  2.macrosを使用してカスタムmacroを作成する。 macroとは JinjaTemplateを使用してTask内で利用できる変数のようなもの。\nprint('実行日は {{execution_date}}') 詳細：https://airflow.apache.org/docs/apache-airflow/stable/templates-ref.html\nplugins_folder配下のファイル plugins_folder配下に__init__.pyを作成してそこに記載する形で書いていく。\n __init__.py  関数に作成するmacroについて定義していく。  関数名がmacro名 関数の戻り値がmacroのvalueとなる      from airflow.plugins_manager import AirflowPlugin def plugin_macro(x: int): return x + 1 class MyPlugins(AirflowPlugin): name = \"my_plugins_poyo\" macros = [plugin_macro] 上記の場合、plugin_macroというmacroを定義しており、そのmacroは引数x:intをx + 1した形で返すということをしている。\n作成を反映させる。 webserverの再起動が必要。\ndagのファイルから利用してみる  dagのファイル  作成したmacroはmacros..で取得できる。    from airflow.decorators import task, dag from airflow.utils.dates import days_ago @task def test_output(**kwargs): macros = kwargs['macros'] input = 1 print(f'input: {input}') print(f'output: {macros.my_plugins_poyo.plugin_macro(input)}') @dag(start_date=days_ago(2)) def test_plugins(): test_output() test_plugins()  log  上記DAGを実行してみたLogだが、引数1に対しoutputが2となっているのでmacroが効いていることを確認できる。    [2023-01-04, 18:31:16 JST] {logging_mixin.py:137} INFO - input: 1 [2023-01-04, 18:31:16 JST] {logging_mixin.py:137} INFO - output: 2  3.flask_blueprintsを使用してAirflowのFlaskにflask.BluePrint製のページを作成する。 flask.BluePrintとは Flask内でアプリケーションの機能を複数のファイルに分割する方法。ソースコードが長すぎる場合に、機能ごとにファイルを分割し管理しやすくするために利用する。\nplugins_folder配下のファイル plugins_folder配下に__init__.pyを作成してそこに記載する形で書いていく。\n __init__.py  airflow.plugins_manager.AirflowPluginを拡張してかく。 @bp.routeに渡したパスが追加したいページのhttp://:/直下のSubpathとなる。    from flask import Blueprint from airflow.plugins_manager import AirflowPlugin bp = Blueprint('app2', __name__) @bp.route('/bp_test') def bp_test(): \"\"\" 今日の天気を取得して表示する \"\"\" import requests import json res = requests.get('https://weather.tsukumijima.net/api/forecast/city/220030') today_weather = json.loads(res.text)['forecasts'][0] return today_weather['date'] + ' ' + today_weather['detail']['weather'] class MyPlugins(AirflowPlugin): name = \"my_plugins_poyo\" flask_blueprints = [bp] 上記の場合、Subpathが/bp_testであるページを追加しており、ページを開くとweatherAPIを使用して任意の市の今日の日付と天気を取得し表示するようなことをしている。\n作成を反映させる。 webserverの再起動が必要。\n作成したページにアクセスしてみる。  http://:/bp_testへアクセスすると以下のようなページが表示される。   4.appbuilder_viewsを使用してAirflowのFlaskにflask_appbuilder.BaseView製のページを作成する。 flask_appbuilder.BaseViewとは FlaskのViewのうち、よりきめ細かくセキュリティ(メソッド,アクセス)を設定できるView。\nplugins_folder配下のファイル plugins_folder配下に__init__.pyを作成してそこに記載する形で書いていく。\n __init__.py  AirflowのメニューバーのセクションにViewのLinkを設定する形で書いていく。  category:strに渡した値がメニューバー名 name:strに渡した値がセクション名      from airflow.plugins_manager import AirflowPlugin from flask_appbuilder import expose, BaseView as AppBuilderBaseView class TestAppBuilderBaseView(AppBuilderBaseView): default_view = \"test\" @expose('/') def test(self): \"\"\" hello test_pageを表示する \"\"\" return 'hello test_page' v_appbuilder_view = TestAppBuilderBaseView() v_appbuilder_package = { \"name\": \"Test View\", \"category\": \"Test Plugin\", \"view\": v_appbuilder_view, } class MyPlugins(AirflowPlugin): name = \"my_plugins_poyo\" appbuilder_views = [v_appbuilder_package] 上記の場合、メニューバー名Test Pluginセクション名Test ViewにViewへのLinkを設定しており、Linkをアクセスすると’hello test_page’と表示されることを期待している。\n作成を反映させる。 webserverの再起動が必要。\n作成したページにアクセスしてみる。  期待通りのメニューバーとセクションができている。   Viewへアクセスしてみるとページが正常に確認できる。   5.appbuilder_menu_itemsをしてAirflow UIのメニューにセクションとリンクを作成する。 plugins_folder配下のファイル plugins_folder配下に__init__.pyを作成してそこに記載する形で書いていく。\n __init__.py  4.appbuilder_viewsの説明と同様  category:strに渡した値がメニューバー名 name:strに渡した値がセクション名      from airflow.plugins_manager import AirflowPlugin appbuilder_mitem = { \"name\": \"467 notes\", \"href\": \"https://467tn.com\", \"category\": \"MyPages\", } class MyPlugins(AirflowPlugin): name = \"my_plugins_poyo\" appbuilder_menu_items = [appbuilder_mitem] 上記の場合、メニューバー名MyPagesセクション名467 notesにViewへのLinkを設定しており、Linkをアクセスするとhref先のページへ遷移されることを期待している。\n作成を反映させる。 webserverの再起動が必要。\n作成したページにアクセスしてみる。  期待通りのメニューバーとセクションができている。また、セクション先をアクセスするとhttps://467tn.comへ遷移される。   6.global_operator_extra_linksを使用して全ての種類のOperatorにLinkを作成する AirflowのOperatorLinkとは Taskの詳細画面につけるボタンLink(うまい表現がわかりません)。基底がBaseOperatorLinkとなっており、ボタンLinkをClickすると当クラスのget_link:functionが実行されるわけだが、get_link:functionには引数として当Taskのoperator(BaseOperator)とti_key(airflow.models.taskinstance.TaskInstanceKey)が渡される。なのでこのOperatorLinkを使えば、Operatorが外部インタフェースと通信するようなOperatorだった場合に外部インタフェース先にあるLogなどをti_keyをもとに表示するようなことができます。 例えば標準でprovideされているOperatorLinkのうち、BigQueryConsoleLinkは、BigQueryOperatorを使用してBigQueryに投げたLogをGoogleCloudConsoleから当job_idを指定して確認することができるような仕様をしているOperatorLinkです。\n詳細：https://airflow.apache.org/docs/apache-airflow/stable/howto/define_extra_link.html\nplugins_folder配下のファイル plugins_folder配下に__init__.pyを作成してそこに記載する形で書いていく。\n __init__.py  BaseOperatorLinkを拡張して書く。  name:propertyに渡した値がボタンLink名 get_link:functionに定義した処理はボタンLinkをClickした時に動作する挙動。  戻り値としてstrでLinkPathを記載。        from airflow.plugins_manager import AirflowPlugin from airflow.models.baseoperator import BaseOperatorLink class GlobalLink(BaseOperatorLink): name = \"Airflow docs\" def get_link(self, operator, *, ti_key=None): return \"https://airflow.apache.org/\" class MyPlugins(AirflowPlugin): name = \"my_plugins_poyo\" global_operator_extra_links = [ GlobalLink(), ] 上記の場合、Airflow docsというボタンLinkを作成しており、ボタンLinkをClickするとhttps://airflow.apache.org/へ遷移する。\n作成を反映させる。 webserverの再起動が必要。\n作成したLinkを確認してみる。  任意のTaskの詳細を開くとOperatorの種類に限らず期待通りのボタンLinkが作られていることを確認できる。ボタンLinkをクリックするとhttps://airflow.apache.org/へ遷移する。   7.operator_extra_linksを使用して任意の種類のOperatorにLinkを作成する。 OperatorLinkとは 「6.global_operator_extra_links」での説明と同様なので割愛。\nplugins_folder配下のファイル plugins_folder配下に__init__.pyを作成してそこに記載する形で書いていく。\n __init__.py  BaseOperatorLinkを拡張して書く。  name:propertyとget_link:functionの仕様については「6.global_operator_extra_links」での説明と同様。 operators:List[BaseOperator]にLinkを反映したいOperatorを列挙する。      from airflow.plugins_manager import AirflowPlugin from airflow.models.baseoperator import BaseOperatorLink from airflow.providers.cncf.kubernetes.operators.kubernetes_pod import ( KubernetesPodOperator, ) class MyLink(BaseOperatorLink): name = \"Kubernetes docs\" operators = [KubernetesPodOperator] def get_link(self, operator, *, ti_key=None): return \"https://kubernetes.io/\" class MyPlugins(AirflowPlugin): name = \"my_plugins_poyo\" operator_extra_links = [ MyLink(), ] 上記の場合、Kubernetes docsというボタンLinkを作成しており、ボタンLinkをClickするとhttps://kubernetes.io/へ遷移する。またこのLinkはKubernetesPodOperatorを使用したTaskにしか反映されないことを意図としている。\n作成を反映させる。 webserverの再起動が必要。\n作成したLinkを確認してみる。 KubernetesPodOperatorのあるDAGを開いて確認してみる。\n KubernetesPodOperatorのTaskに期待通りのボタンLinkが作られていることを確認できる。ボタンLinkをクリックするとhttps://kubernetes.io/へ遷移する。   PythonOperatorのTaskにはボタンLinkが作られていない。   8.timetablesを使用してCRONでは表現できないスケジュールを作成する 個人的な本題だったので少し他よりも丁寧に書く。\nTimetableとは AirflowのDAG内での「Cronで表すことができないようなスケジュール」を決めるためのTimeTable。DAGに渡すtimetable引数で指定できる。\n 「Cronで表すことができないようなスケジュール」とは  例えば以下のようなスケジュール。 実行間隔が不規則  2022.12.31 10:00/2023.01.03 10:00のみ実行するなど   毎日異なる時間に実行する  水曜日は10:00、木曜日は03:00に実行するなど   グレゴリオ暦に従わないスケジュール   標準でprovideされているTimeTable  EventsTimetable CronTriggerTimetable    詳細：https://airflow.apache.org/docs/apache-airflow/stable/concepts/timetable.html\n独自のTimetable作成方法について Airflow2.2から独自のTimeTableを作成することができるようになった。airflow.timetables.base.Timetableを拡張すれば良いのだが、以下の関数を含める必要がある。\n   関数名 about     next_dagrun_info スケジュール実行時のデータ間隔を返す   infer_manual_data_interval 手動実行時のデータ間隔で返す    独自のTimetableに指定する関数を作成する。 今回は以下のような仕様のTimeTableを作ってみます。\n 1日に2回,06:00(①)と16:30(②)にジョブを実行する。実行時に取得するデータの間隔は以下。  06:00(①)実行時・・・前日の16:30~当日の06:00 16:30(②)実行時・・・当日の06:00~当日の16:30    next_dagrun_info関数  データの間隔をDagRunInfo(run_after:DateTime, data_interval:DataInterval)で返す parameterに入ってくるrestriction:TimeRestrictionとはDAGをスケジュールできる期間に関する制限(earliest:DateTime,latest:DateTime,catchup:bool)を持つクラス。  def next_dagrun_info(  self,  *,  last_automated_data_interval: Optional[DataInterval],  restriction: TimeRestriction, ) - Optional[DagRunInfo]:  if last_automated_data_interval is not None: # a  last_start = last_automated_data_interval.start  delta = timedelta(days=1)  if last_start.hour == 6: # b  next_start = last_start.set(hour=16, minute=30).replace(tzinfo=UTC)  next_end = (last_start+delta).replace(tzinfo=UTC)  else: # c  next_start = (last_start+delta).set(hour=6, minute=0).replace(tzinfo=UTC)  next_end = (last_start+delta).replace(tzinfo=UTC) 　else: # d  next_start = restriction.earliest  if next_start is None:  return None  if not restriction.catchup:  next_start = max(next_start, DateTime.combine(Date.today(), Time.min).replace(tzinfo=UTC))  next_start = next_start.set(hour=6, minute=0).replace(tzinfo=UTC)  next_end = next_start.set(hour=16, minute=30).replace(tzinfo=UTC)  if restriction.latest is not None and next_start  restriction.latest: # e  return None  return DagRunInfo.interval(start=next_start, end=next_end) 長い行になりましたが補足すると以下\n 初回実行ではない場合(a)  前回実行のデータ間隔のStartが06:00の場合(b)  今回の実行は①に該当する next_startは前回の当日の16:30 next_endは前回の翌日の06:00   前回実行のデータ間隔のStartが16:30の場合(c)  今回の実行は②に該当する next_startは前回の翌日の06:00 next_endは前回の翌日の16:30     初回実行の場合(d)  DAGをスケジュールできる期間のうちの最早い日を実行日(next_start)として（catchup=Falseの場合、現在の日付を実行日(next_start)とする）  next_startは実行日の06:00 next_endは実行日の16:30     またこの時DAGの終了日(restriction.latest)がある場合、その日を越したnext_endを実行しないことを期待している。(e)  infer_manual_data_interval関数  スケジュール実行時のデータの間隔をDataInterval(start: DateTime, end:Datetime)で返す。  def infer_manual_data_interval(self, run_after: DateTime) - DataInterval:  delta = timedelta(days=1)  # a  if run_after = run_after.set(hour=6, minute=0) and run_after  run_after.set(hour=16, minute=30):  start = (run_after-delta).set(hour=16, minute=30, second=0).replace(tzinfo=UTC)  end = run_after.set(hour=6, minute=0, second=0).replace(tzinfo=UTC)  # b  elif run_after = run_after.set(hour=16, minute=30) and run_after.hour  23:  start = run_after.set(hour=6, minute=0, second=0).replace(tzinfo=UTC)  end = run_after.set(hour=16, minute=30, second=0).replace(tzinfo=UTC)  # c  else:  start = (run_after-delta).set(hour=6, minute=0).replace(tzinfo=UTC)  end = (run_after-delta).set(hour=16, minute=30).replace(tzinfo=UTC)  return DataInterval(start=start, end=end) 補足すると\n 現在時刻が06:00~16:30の間(a)  ①の実行とされる。 startは前日の16:30、endは当日の06:00   現在の時刻が16:30~23:00の間(b)  ②の実行とされる。 startは当日の06:00、endは当日の16:30   それ以外、深夜の00:00~05:59の間(c)  ②の実行とされる。 startは前日の06:00、endは前日の16:30    plugins_folder配下のファイル  ファイル構造  ├── __init__.py └── timetables ├── __init__.py └── airflow_timetable_template.py  __init__.py  from airflow.plugins_manager import AirflowPlugin import timetables class MyPlugins(AirflowPlugin): name = \"my_plugins_poyo\" timetables = [timetables.MyTimeTable]  timetables/__init__.py  from timetables.airflow_timetable_template import MyTimeTable __all__ = ['MyTimeTable']  timetables/airflow_timetable_template.py 上記で書いた関数をそのまま移植していきます。TimeTable名はMyTimeTable  from datetime import timedelta from typing import Optional from pendulum import Date, DateTime, Time, timezone from airflow.plugins_manager import AirflowPlugin from airflow.timetables.base import DagRunInfo, DataInterval, TimeRestriction, Timetable UTC = timezone(\"UTC\") class MyTimeTable(Timetable): def infer_manual_data_interval(self, run_after: DateTime) - DataInterval: ・・・ def next_dagrun_info( self, *, last_automated_data_interval: Optional[DataInterval], restriction: TimeRestriction, ) - Optional[DagRunInfo]: ・・・ 作成を反映させる。 webserverとschedulerの再起動が必要。(TimeTableはschedulerも読み込む必要があるためschedulerも再起動します。再起動しないとTimetableNotRegisteredErrorが出ます。)\n作成したTimeTableを試してみる。  dagのファイル 適当なDAGのtimetable引数に作成したMyTimeTable:TimeTableを渡す。importErrorが出てなければ正常に動作しているはず、  from timetables.airflow_timetable_template import MyTimeTable @dag(start_date=days_ago(2), timetable=MyTimeTable()) ...  UIから作成したDAGの確認  ScheduleがMyTimeTableになっている 現在時刻が01/05.14:08の場合  次の実行は01/05.16:30 次の次の実行は01/06.06:00。その時のデータ間隔は01/05.16:30~01/06.06:00        終わり 以上AirflowのPluginについて見ていきました。TimeTableについては、AirflowのScheduleについて再度理解する機会になってよかったです。また時間があるときにlistenerやexecutorのカスタムも試してみたいです。\n参考  https://docs.astronomer.io/learn/scheduling-in-airflow#timetables https://docs.astronomer.io/learn/using-airflow-plugins https://airflow.apache.org/docs/apache-airflow/stable/plugins.html  ","wordCount":"875","inLanguage":"en","image":"https://user-images.githubusercontent.com/60976262/191047722-dd7ed9ad-6e00-4b50-8073-24ae9602b8d6.png","datePublished":"2023-01-04T11:30:03Z","dateModified":"2023-01-04T11:30:03Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://467tn.com/post/content8/"},"publisher":{"@type":"Organization","name":"467tn.com","logo":{"@type":"ImageObject","url":"https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://467tn.com accesskey=h title="  (Alt + H)"><img src=https://467tn.com/home.png alt aria-label=logo height=35></a><div class=logo-switches></div></div><ul id=menu><li><a href=https://467tn.com/ title=whoami><span>whoami</span></a></li><li><a href=https://467tn.com/post/ title=post><span>post</span></a></li><li><a href=https://467tn.com/tags/ title=tags><span>tags</span></a></li><li><a href=https://filmarks.com/users/467 title=filmarks><span>filmarks</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://s6n.hatenablog.com/ title=travels><span>travels</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://zenn.dev/467 title=zenn><span>zenn</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://467tn.com>Home</a>&nbsp;»&nbsp;<a href=https://467tn.com/post/>Posts</a></div><h1 class=post-title>AirflowのPluginsについて</h1><div class=post-description>カスタマイズ機能についてです</div><div class=post-meta><span title="2023-01-04 11:30:03 +0000 +0000">January 4, 2023</span>&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/srn221B/blog/tree/master/content/post/content8.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#airflowpluginsとは>AirflowPluginsとは</a><ul><li><a href=#どんな時にairflowpluginsを使うのか>どんな時にAirflowPluginsを使うのか</a></li></ul></li><li><a href=#新規plugin作成方法>新規Plugin作成方法</a></li><li><a href=#plugin確認方法>Plugin確認方法</a></li><li><a href=#どんなcomponentをpluginに追加することができるのか>どんなComponentをPluginに追加することができるのか</a><ul><li><a href=#1hooksを使用して独自のhookを作成する>1.hooksを使用して独自のHookを作成する。</a></li><li><a href=#2macrosを使用してカスタムmacroを作成する>2.macrosを使用してカスタムmacroを作成する。</a></li><li><a href=#3flask_blueprintsを使用してairflowのflaskにflaskblueprint製のページを作成する>3.flask_blueprintsを使用してAirflowのFlaskにflask.BluePrint製のページを作成する。</a></li><li><a href=#4appbuilder_viewsを使用してairflowのflaskにflask_appbuilderbaseview製のページを作成する>4.appbuilder_viewsを使用してAirflowのFlaskにflask_appbuilder.BaseView製のページを作成する。</a></li><li><a href=#5appbuilder_menu_itemsをしてairflow-uiのメニューにセクションとリンクを作成する>5.appbuilder_menu_itemsをしてAirflow UIのメニューにセクションとリンクを作成する。</a></li><li><a href=#6global_operator_extra_linksを使用して全ての種類のoperatorにlinkを作成する>6.global_operator_extra_linksを使用して<strong>全ての種類の</strong>OperatorにLinkを作成する</a></li><li><a href=#7operator_extra_linksを使用して任意の種類のoperatorにlinkを作成する>7.operator_extra_linksを使用して<strong>任意の種類の</strong>OperatorにLinkを作成する。</a></li><li><a href=#8timetablesを使用してcronでは表現できないスケジュールを作成する>8.timetablesを使用してCRONでは表現できないスケジュールを作成する</a></li></ul></li><li><a href=#終わり>終わり</a></li><li><a href=#参考>参考</a></li></ul></nav></div></details></div><div class=post-content><h2 id=airflowpluginsとは>AirflowPluginsとは<a hidden class=anchor aria-hidden=true href=#airflowpluginsとは>#</a></h2><p>Airflowをカスタマイズするために追加できるPlugin。</p><h3 id=どんな時にairflowpluginsを使うのか>どんな時にAirflowPluginsを使うのか<a hidden class=anchor aria-hidden=true href=#どんな時にairflowpluginsを使うのか>#</a></h3><p>例えば以下のようなときにAirflowPluginsを使う。</p><ul><li>AirflowのメタデータのDBのコンテンツを表示するViewを作成したいとき。</li><li>指定された時間内において任意数のDAGが失敗時にAirflowの機能を監視しカスタムアラートを送信するアプリケーションを作成したいとき。</li><li>外部データツールのファイルやログに動的にリンクする詳細ビューをUIに表示したいとき。</li></ul><h2 id=新規plugin作成方法>新規Plugin作成方法<a hidden class=anchor aria-hidden=true href=#新規plugin作成方法>#</a></h2><p>「plugins_folder」へPythonファイルを用意し、Pythonファイル内で<a href=https://github.com/apache/airflow/blob/a9493c13173f6108c02c42d2f4f60b82b5ccc71a/airflow/plugins_manager.py#L134>airflow.plugins_manager.AirflowPlugin</a>を拡張するクラスを定義すれば新規Pluginを作成できる。</p><ul><li>Pythonファイルの例<ul><li>定義したAirflowPluginクラスには以下を実装する。<ul><li><code>name:property</code>にPlugin名</li><li><code>on_load:function</code>にPluginのロード時に実行してほしい処理</li><li>そのほかPluginに追加したいComponent(Pluginの機能)について列挙</li></ul></li></ul></li></ul><pre tabindex=0><code>from airflow.plugins_manager import AirflowPlugin

class MyAirflowPlugin(AirflowPlugin):
    name = &#34;empty&#34;
    def on_load(cls, *args, **kwargs):
        pass
    # そのほかPluginに追加したいComponentについて列挙していく。
</code></pre><p>上記場合、Plugin名が「empty」であるPluginを作成している。</p><ul><li>「plugins_folder」の確認の仕方<ul><li>ちなみに「plugins_folder」はどこで確認できるのかというのだが、「コマンドを利用する」か「cfgファイルを見る」の2通りで確認できる。</li><li>基本的にデフォルトでは$AIRFLOW_HOME/pluginsになっているはず。</li></ul></li></ul><pre tabindex=0><code># コマンドを利用する
$ airflow info  | grep plugins_folder
plugins_folder         | xxx               
# cfgファイルを見る
$ cat airflow.cfg | grep plugins_folder
plugins_folder = xxxx
</code></pre><h2 id=plugin確認方法>Plugin確認方法<a hidden class=anchor aria-hidden=true href=#plugin確認方法>#</a></h2><p>現在追加されているPluginは何か、Pluginに定義されてあるComponentは何かを確認する方法だが、「UIから確認する方法」と「CLIを利用して確認する方法」がある。WebServerを再起動しなくてもすぐに反映されるのは後者の方法。</p><ul><li>「UIから確認する方法」<ul><li>UIのAdmin->Pluginsを使用する。</li></ul></li></ul><p><img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/47201792a899-20230105.png alt></p><ul><li>「CLIを利用して確認する方法」<ul><li>airflow pluginsを実行する。</li></ul></li></ul><pre tabindex=0><code>$ airflow plugins
name            | source                      | appbuilder_views                                                                            | macros               
================+=============================+=============================================================================================+======================
my_plugins_poyo | $PLUGINS_FOLDER/__init__.py | {&#39;name&#39;: &#39;Test View&#39;, &#39;category&#39;: &#39;Test Plugin&#39;, &#39;view&#39;: &#39;__init__.TestAppBuilderBaseView&#39;} | __init__.plugin_macro
</code></pre><h2 id=どんなcomponentをpluginに追加することができるのか>どんなComponentをPluginに追加することができるのか<a hidden class=anchor aria-hidden=true href=#どんなcomponentをpluginに追加することができるのか>#</a></h2><p>例えば以下のようなComponentが現在ある。種類としてUIへの機能追加からScheduling、DAG作成する上での機能追加などなどがある。詳細については<a href=https://airflow.apache.org/docs/apache-airflow/stable/plugins.html>ドキュメント</a>を確認すると良い。</p><table><thead><tr><th>No</th><th>Component</th><th>About</th></tr></thead><tbody><tr><td>1</td><td>hooks</td><td>独自のHookを作成する</td></tr><tr><td>2</td><td>macros</td><td>カスタムmacroを作成する</td></tr><tr><td>3</td><td>flask_blueprints</td><td>AirflowのFlaskにflask.BluePrint製のページを作成する</td></tr><tr><td>4</td><td>appbuilder_views</td><td>AirflowのFlaskにflask_appbuilder.BaseView製のページを作成する</td></tr><tr><td>5</td><td>appbuilder_menu_items</td><td>Airflow UIのメニューにセクションとリンクを作成する</td></tr><tr><td>6</td><td>global_operator_extra_links</td><td><strong>全ての種類の</strong>OperatorにLinkを作成する</td></tr><tr><td>7</td><td>operator_extra_links</td><td><strong>任意の種類の</strong>OperatorにLinkを作成する</td></tr><tr><td>8</td><td>timetables</td><td>CRONでは表現できないスケジュールを作成する</td></tr></tbody></table><p>そのほか「executorを使用してCustomExecutorを作成する」「listenerを使用してイベント検知を作成する」などできそう。</p><p>今回は上記のComponentのみ順に試してみます。</p><hr><h3 id=1hooksを使用して独自のhookを作成する>1.hooksを使用して独自のHookを作成する。<a hidden class=anchor aria-hidden=true href=#1hooksを使用して独自のhookを作成する>#</a></h3><h4 id=airflowのhookとは>AirflowのHookとは<a hidden class=anchor aria-hidden=true href=#airflowのhookとは>#</a></h4><p>外部システムとのインタフェースの役割をしてくれるようなもの。例えば以下のように書いて一貫したメソッドを提供することを意図としてある。</p><pre tabindex=0><code>pg_hook = PostgresHook.get_hook(conn_id)
pg_hook.copy_exper()
</code></pre><p>詳細：<a href=https://airflow.apache.org/docs/apache-airflow/stable/concepts/connections.html>https://airflow.apache.org/docs/apache-airflow/stable/concepts/connections.html</a></p><h4 id=plugins_folder配下のファイル>plugins_folder配下のファイル<a hidden class=anchor aria-hidden=true href=#plugins_folder配下のファイル>#</a></h4><p>今回は次のようなファイル構造で新規独自のHookを作成していきます。</p><pre tabindex=0><code>.
├── __init__.py　# pluginについて定義
├── hooks
│   ├── __init__.py
│   └── airflow_hook_template.py # Hookについて定義
</code></pre><ul><li><code>__init__.py</code></li></ul><pre tabindex=0><code>from __future__ import division, absolute_import, print_function
import hooks
from airflow.plugins_manager import AirflowPlugin


class MyPlugins(AirflowPlugin):
    name = &#34;my_plugins_poyo&#34;
    hooks = [hooks.PluginHook]
</code></pre><ul><li><code>hooks/__init__.py</code></li></ul><pre tabindex=0><code>from hooks.airflow_hook_template import PluginHook

__all__ = [&#39;PluginHook&#39;]
</code></pre><ul><li><code>hooks/airflow_hook_template.py</code><ul><li>airflow.hooks.base.BaseHookを拡張して書く。</li></ul></li></ul><pre tabindex=0><code>from airflow.hooks.base import BaseHook


class PluginHook(BaseHook):
    pass
</code></pre><p>上記の場合、特に何もしないHook。</p><h4 id=作成を反映させる>作成を反映させる。<a hidden class=anchor aria-hidden=true href=#作成を反映させる>#</a></h4><p>webserverの再起動が必要。</p><h4 id=dagのファイルからimportしてみる>dagのファイルからimportしてみる<a hidden class=anchor aria-hidden=true href=#dagのファイルからimportしてみる>#</a></h4><p>plugins_folderは環境変数<code>PYTHONPATH</code>として自動的にbuildされている(<a href=https://airflow.apache.org/docs/apache-airflow/stable/modules_management.html#built-in-pythonpath-entries-in-airflow>https://airflow.apache.org/docs/apache-airflow/stable/modules_management.html#built-in-pythonpath-entries-in-airflow</a>)ので,直接plugins_folder配下のディレクトリを指定する形でimportできる。UIからDAGを確認するなどをしてimportErrorが出ていなければ正常に動作している。</p><ul><li>dagのファイル</li></ul><pre tabindex=0><code>from hooks.airflow_hook_template import PluginHook
</code></pre><hr><h3 id=2macrosを使用してカスタムmacroを作成する>2.macrosを使用してカスタムmacroを作成する。<a hidden class=anchor aria-hidden=true href=#2macrosを使用してカスタムmacroを作成する>#</a></h3><h4 id=macroとは>macroとは<a hidden class=anchor aria-hidden=true href=#macroとは>#</a></h4><p>JinjaTemplateを使用してTask内で利用できる変数のようなもの。</p><pre tabindex=0><code>print(&#39;実行日は {{execution_date}}&#39;)
</code></pre><p>詳細：<a href=https://airflow.apache.org/docs/apache-airflow/stable/templates-ref.html>https://airflow.apache.org/docs/apache-airflow/stable/templates-ref.html</a></p><h4 id=plugins_folder配下のファイル-1>plugins_folder配下のファイル<a hidden class=anchor aria-hidden=true href=#plugins_folder配下のファイル-1>#</a></h4><p>plugins_folder配下に<code>__init__.py</code>を作成してそこに記載する形で書いていく。</p><ul><li><code>__init__.py</code><ul><li>関数に作成するmacroについて定義していく。<ul><li>関数名がmacro名</li><li>関数の戻り値がmacroのvalueとなる</li></ul></li></ul></li></ul><pre tabindex=0><code>from airflow.plugins_manager import AirflowPlugin

def plugin_macro(x: int): 
    return x + 1 

class MyPlugins(AirflowPlugin):
    name = &#34;my_plugins_poyo&#34;
    macros = [plugin_macro]
</code></pre><p>上記の場合、<code>plugin_macro</code>というmacroを定義しており、そのmacroは引数<code>x:int</code>を<code>x + 1</code>した形で返すということをしている。</p><h4 id=作成を反映させる-1>作成を反映させる。<a hidden class=anchor aria-hidden=true href=#作成を反映させる-1>#</a></h4><p>webserverの再起動が必要。</p><h4 id=dagのファイルから利用してみる>dagのファイルから利用してみる<a hidden class=anchor aria-hidden=true href=#dagのファイルから利用してみる>#</a></h4><ul><li>dagのファイル<ul><li>作成したmacroは<code>macros.&lt;plugin_name>.&lt;macro_name></code>で取得できる。</li></ul></li></ul><pre tabindex=0><code>from airflow.decorators import task, dag
from airflow.utils.dates import days_ago

@task
def test_output(**kwargs):
    macros = kwargs[&#39;macros&#39;]
    input = 1
    print(f&#39;input: {input}&#39;)
    print(f&#39;output: {macros.my_plugins_poyo.plugin_macro(input)}&#39;)

@dag(start_date=days_ago(2))
def test_plugins():
    test_output()
    
test_plugins()
</code></pre><ul><li>log<ul><li>上記DAGを実行してみたLogだが、引数<code>1</code>に対しoutputが<code>2</code>となっているのでmacroが効いていることを確認できる。</li></ul></li></ul><pre tabindex=0><code>[2023-01-04, 18:31:16 JST] {logging_mixin.py:137} INFO - input: 1
[2023-01-04, 18:31:16 JST] {logging_mixin.py:137} INFO - output: 2
</code></pre><hr><h3 id=3flask_blueprintsを使用してairflowのflaskにflaskblueprint製のページを作成する>3.flask_blueprintsを使用してAirflowのFlaskにflask.BluePrint製のページを作成する。<a hidden class=anchor aria-hidden=true href=#3flask_blueprintsを使用してairflowのflaskにflaskblueprint製のページを作成する>#</a></h3><h4 id=flaskblueprintとは>flask.BluePrintとは<a hidden class=anchor aria-hidden=true href=#flaskblueprintとは>#</a></h4><p>Flask内でアプリケーションの機能を複数のファイルに分割する方法。ソースコードが長すぎる場合に、機能ごとにファイルを分割し管理しやすくするために利用する。</p><h4 id=plugins_folder配下のファイル-2>plugins_folder配下のファイル<a hidden class=anchor aria-hidden=true href=#plugins_folder配下のファイル-2>#</a></h4><p>plugins_folder配下に<code>__init__.py</code>を作成してそこに記載する形で書いていく。</p><ul><li><code>__init__.py</code><ul><li>airflow.plugins_manager.AirflowPluginを拡張してかく。</li><li><code>@bp.route</code>に渡したパスが追加したいページの<code>http://&lt;airflow webserver IP>:&lt;port>/</code>直下のSubpathとなる。</li></ul></li></ul><pre tabindex=0><code>from flask import Blueprint
from airflow.plugins_manager import AirflowPlugin


bp = Blueprint(&#39;app2&#39;, __name__)

@bp.route(&#39;/bp_test&#39;)
def bp_test():
    &#34;&#34;&#34; 今日の天気を取得して表示する
    &#34;&#34;&#34;
    import requests
    import json
    res = requests.get(&#39;https://weather.tsukumijima.net/api/forecast/city/220030&#39;)
    today_weather = json.loads(res.text)[&#39;forecasts&#39;][0]
    return today_weather[&#39;date&#39;] + &#39; &#39; + today_weather[&#39;detail&#39;][&#39;weather&#39;]

class MyPlugins(AirflowPlugin):
    name = &#34;my_plugins_poyo&#34;
    flask_blueprints = [bp]
</code></pre><p>上記の場合、Subpathが<code>/bp_test</code>であるページを追加しており、ページを開くとweatherAPIを使用して任意の市の今日の日付と天気を取得し表示するようなことをしている。</p><h4 id=作成を反映させる-2>作成を反映させる。<a hidden class=anchor aria-hidden=true href=#作成を反映させる-2>#</a></h4><p>webserverの再起動が必要。</p><h4 id=作成したページにアクセスしてみる>作成したページにアクセスしてみる。<a hidden class=anchor aria-hidden=true href=#作成したページにアクセスしてみる>#</a></h4><ul><li><code>http://&lt;airflow webserver IP>:&lt;port>/bp_test</code>へアクセスすると以下のようなページが表示される。</li></ul><p><img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/abade4eefcce-20230104.png alt></p><hr><h3 id=4appbuilder_viewsを使用してairflowのflaskにflask_appbuilderbaseview製のページを作成する>4.appbuilder_viewsを使用してAirflowのFlaskにflask_appbuilder.BaseView製のページを作成する。<a hidden class=anchor aria-hidden=true href=#4appbuilder_viewsを使用してairflowのflaskにflask_appbuilderbaseview製のページを作成する>#</a></h3><h4 id=flask_appbuilderbaseviewとは>flask_appbuilder.BaseViewとは<a hidden class=anchor aria-hidden=true href=#flask_appbuilderbaseviewとは>#</a></h4><p>FlaskのViewのうち、よりきめ細かくセキュリティ(メソッド,アクセス)を設定できるView。</p><h4 id=plugins_folder配下のファイル-3>plugins_folder配下のファイル<a hidden class=anchor aria-hidden=true href=#plugins_folder配下のファイル-3>#</a></h4><p>plugins_folder配下に<code>__init__.py</code>を作成してそこに記載する形で書いていく。</p><ul><li><code>__init__.py</code><ul><li>AirflowのメニューバーのセクションにViewのLinkを設定する形で書いていく。<ul><li><code>category:str</code>に渡した値がメニューバー名</li><li><code>name:str</code>に渡した値がセクション名</li></ul></li></ul></li></ul><pre tabindex=0><code>from airflow.plugins_manager import AirflowPlugin
from flask_appbuilder import expose, BaseView as AppBuilderBaseView


class TestAppBuilderBaseView(AppBuilderBaseView):
    default_view = &#34;test&#34;
    @expose(&#39;/&#39;)
    def test(self):
        &#34;&#34;&#34; hello test_pageを表示する
        &#34;&#34;&#34;
        return &#39;hello test_page&#39;

v_appbuilder_view = TestAppBuilderBaseView()
v_appbuilder_package = {
    &#34;name&#34;: &#34;Test View&#34;,
    &#34;category&#34;: &#34;Test Plugin&#34;,
    &#34;view&#34;: v_appbuilder_view,
}

class MyPlugins(AirflowPlugin):
    name = &#34;my_plugins_poyo&#34;
    appbuilder_views = [v_appbuilder_package]
</code></pre><p>上記の場合、メニューバー名<code>Test Plugin</code>セクション名<code>Test View</code>にViewへのLinkを設定しており、Linkをアクセスすると&rsquo;hello test_page&rsquo;と表示されることを期待している。</p><h4 id=作成を反映させる-3>作成を反映させる。<a hidden class=anchor aria-hidden=true href=#作成を反映させる-3>#</a></h4><p>webserverの再起動が必要。</p><h4 id=作成したページにアクセスしてみる-1>作成したページにアクセスしてみる。<a hidden class=anchor aria-hidden=true href=#作成したページにアクセスしてみる-1>#</a></h4><ul><li>期待通りのメニューバーとセクションができている。</li></ul><p><img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/7e0c9ebbbf00-20230105.png alt></p><ul><li>Viewへアクセスしてみるとページが正常に確認できる。</li></ul><p><img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/c86b0a906497-20230105.png alt></p><hr><h3 id=5appbuilder_menu_itemsをしてairflow-uiのメニューにセクションとリンクを作成する>5.appbuilder_menu_itemsをしてAirflow UIのメニューにセクションとリンクを作成する。<a hidden class=anchor aria-hidden=true href=#5appbuilder_menu_itemsをしてairflow-uiのメニューにセクションとリンクを作成する>#</a></h3><h4 id=plugins_folder配下のファイル-4>plugins_folder配下のファイル<a hidden class=anchor aria-hidden=true href=#plugins_folder配下のファイル-4>#</a></h4><p>plugins_folder配下に<code>__init__.py</code>を作成してそこに記載する形で書いていく。</p><ul><li><code>__init__.py</code><ul><li>4.appbuilder_viewsの説明と同様<ul><li><code>category:str</code>に渡した値がメニューバー名</li><li><code>name:str</code>に渡した値がセクション名</li></ul></li></ul></li></ul><pre tabindex=0><code>from airflow.plugins_manager import AirflowPlugin

appbuilder_mitem = {
    &#34;name&#34;: &#34;467 notes&#34;,
    &#34;href&#34;: &#34;https://467tn.com&#34;,
    &#34;category&#34;: &#34;MyPages&#34;,
}

class MyPlugins(AirflowPlugin):
    name = &#34;my_plugins_poyo&#34;
    appbuilder_menu_items = [appbuilder_mitem]
</code></pre><p>上記の場合、メニューバー名<code>MyPages</code>セクション名<code>467 notes</code>にViewへのLinkを設定しており、Linkをアクセスすると<code>href</code>先のページへ遷移されることを期待している。</p><h4 id=作成を反映させる-4>作成を反映させる。<a hidden class=anchor aria-hidden=true href=#作成を反映させる-4>#</a></h4><p>webserverの再起動が必要。</p><h4 id=作成したページにアクセスしてみる-2>作成したページにアクセスしてみる。<a hidden class=anchor aria-hidden=true href=#作成したページにアクセスしてみる-2>#</a></h4><ul><li>期待通りのメニューバーとセクションができている。また、セクション先をアクセスすると<code>https://467tn.com</code>へ遷移される。</li></ul><p><img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/b45c75284248-20230105.png alt></p><hr><h3 id=6global_operator_extra_linksを使用して全ての種類のoperatorにlinkを作成する>6.global_operator_extra_linksを使用して<strong>全ての種類の</strong>OperatorにLinkを作成する<a hidden class=anchor aria-hidden=true href=#6global_operator_extra_linksを使用して全ての種類のoperatorにlinkを作成する>#</a></h3><h4 id=airflowのoperatorlinkとは>AirflowのOperatorLinkとは<a hidden class=anchor aria-hidden=true href=#airflowのoperatorlinkとは>#</a></h4><p>Taskの詳細画面につけるボタンLink(うまい表現がわかりません)。基底が<a href=https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/models/baseoperator/index.html>BaseOperatorLink</a>となっており、ボタンLinkをClickすると当クラスの<code>get_link:function</code>が実行されるわけだが、<code>get_link:function</code>には引数として当Taskのoperator(BaseOperator)とti_key(airflow.models.taskinstance.TaskInstanceKey)が渡される。なのでこのOperatorLinkを使えば、Operatorが外部インタフェースと通信するようなOperatorだった場合に外部インタフェース先にあるLogなどを<code>ti_key</code>をもとに表示するようなことができます。
例えば標準でprovideされているOperatorLinkのうち、BigQueryConsoleLinkは、BigQueryOperatorを使用してBigQueryに投げたLogをGoogleCloudConsoleから当job_idを指定して確認することができるような仕様をしているOperatorLinkです。</p><p>詳細：<a href=https://airflow.apache.org/docs/apache-airflow/stable/howto/define_extra_link.html>https://airflow.apache.org/docs/apache-airflow/stable/howto/define_extra_link.html</a></p><h4 id=plugins_folder配下のファイル-5>plugins_folder配下のファイル<a hidden class=anchor aria-hidden=true href=#plugins_folder配下のファイル-5>#</a></h4><p>plugins_folder配下に<code>__init__.py</code>を作成してそこに記載する形で書いていく。</p><ul><li><code>__init__.py</code><ul><li><a href=https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/models/baseoperator/index.html>BaseOperatorLink</a>を拡張して書く。<ul><li><code>name:property</code>に渡した値がボタンLink名</li><li><code>get_link:function</code>に定義した処理はボタンLinkをClickした時に動作する挙動。<ul><li>戻り値としてstrでLinkPathを記載。</li></ul></li></ul></li></ul></li></ul><pre tabindex=0><code>from airflow.plugins_manager import AirflowPlugin
from airflow.models.baseoperator import BaseOperatorLink

class GlobalLink(BaseOperatorLink):
    name = &#34;Airflow docs&#34;

    def get_link(self, operator, *, ti_key=None):
        return &#34;https://airflow.apache.org/&#34;


class MyPlugins(AirflowPlugin):
    name = &#34;my_plugins_poyo&#34;
    global_operator_extra_links = [
        GlobalLink(),
    ]
</code></pre><p>上記の場合、<code>Airflow docs</code>というボタンLinkを作成しており、ボタンLinkをClickすると<code>https://airflow.apache.org/</code>へ遷移する。</p><h4 id=作成を反映させる-5>作成を反映させる。<a hidden class=anchor aria-hidden=true href=#作成を反映させる-5>#</a></h4><p>webserverの再起動が必要。</p><h4 id=作成したlinkを確認してみる>作成したLinkを確認してみる。<a hidden class=anchor aria-hidden=true href=#作成したlinkを確認してみる>#</a></h4><ul><li>任意のTaskの詳細を開くとOperatorの種類に限らず期待通りのボタンLinkが作られていることを確認できる。ボタンLinkをクリックすると<code>https://airflow.apache.org/</code>へ遷移する。</li></ul><p><img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/904f888118ac-20230105.png alt></p><hr><h3 id=7operator_extra_linksを使用して任意の種類のoperatorにlinkを作成する>7.operator_extra_linksを使用して<strong>任意の種類の</strong>OperatorにLinkを作成する。<a hidden class=anchor aria-hidden=true href=#7operator_extra_linksを使用して任意の種類のoperatorにlinkを作成する>#</a></h3><h4 id=operatorlinkとは>OperatorLinkとは<a hidden class=anchor aria-hidden=true href=#operatorlinkとは>#</a></h4><p>「6.global_operator_extra_links」での説明と同様なので割愛。</p><h4 id=plugins_folder配下のファイル-6>plugins_folder配下のファイル<a hidden class=anchor aria-hidden=true href=#plugins_folder配下のファイル-6>#</a></h4><p>plugins_folder配下に<code>__init__.py</code>を作成してそこに記載する形で書いていく。</p><ul><li><code>__init__.py</code><ul><li><a href=https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/models/baseoperator/index.html>BaseOperatorLink</a>を拡張して書く。<ul><li><code>name:property</code>と<code>get_link:function</code>の仕様については「6.global_operator_extra_links」での説明と同様。</li><li><code>operators:List[BaseOperator]</code>にLinkを反映したいOperatorを列挙する。</li></ul></li></ul></li></ul><pre tabindex=0><code>from airflow.plugins_manager import AirflowPlugin
from airflow.models.baseoperator import BaseOperatorLink
from airflow.providers.cncf.kubernetes.operators.kubernetes_pod import (
    KubernetesPodOperator,
)

class MyLink(BaseOperatorLink):
    name = &#34;Kubernetes docs&#34;
    operators = [KubernetesPodOperator]
    def get_link(self, operator, *, ti_key=None):
        return &#34;https://kubernetes.io/&#34;

class MyPlugins(AirflowPlugin):
    name = &#34;my_plugins_poyo&#34;
    operator_extra_links = [
        MyLink(),
    ]
</code></pre><p>上記の場合、<code>Kubernetes docs</code>というボタンLinkを作成しており、ボタンLinkをClickすると<code>https://kubernetes.io/</code>へ遷移する。またこのLinkは<code>KubernetesPodOperator</code>を使用したTaskにしか反映されないことを意図としている。</p><h4 id=作成を反映させる-6>作成を反映させる。<a hidden class=anchor aria-hidden=true href=#作成を反映させる-6>#</a></h4><p>webserverの再起動が必要。</p><h4 id=作成したlinkを確認してみる-1>作成したLinkを確認してみる。<a hidden class=anchor aria-hidden=true href=#作成したlinkを確認してみる-1>#</a></h4><p>KubernetesPodOperatorのあるDAGを開いて確認してみる。</p><ul><li>KubernetesPodOperatorのTaskに期待通りのボタンLinkが作られていることを確認できる。ボタンLinkをクリックすると<code>https://kubernetes.io/</code>へ遷移する。</li></ul><p><img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/2888bb451e42-20230105.png alt></p><ul><li>PythonOperatorのTaskにはボタンLinkが作られていない。</li></ul><p><img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/5b4d15b5bba1-20230105.png alt></p><hr><h3 id=8timetablesを使用してcronでは表現できないスケジュールを作成する>8.timetablesを使用してCRONでは表現できないスケジュールを作成する<a hidden class=anchor aria-hidden=true href=#8timetablesを使用してcronでは表現できないスケジュールを作成する>#</a></h3><p>個人的な本題だったので少し他よりも丁寧に書く。</p><h4 id=timetableとは>Timetableとは<a hidden class=anchor aria-hidden=true href=#timetableとは>#</a></h4><p>AirflowのDAG内での「Cronで表すことができないようなスケジュール」を決めるためのTimeTable。DAGに渡す<code>timetable</code>引数で指定できる。</p><ul><li>「Cronで表すことができないようなスケジュール」とは<ul><li>例えば以下のようなスケジュール。</li><li>実行間隔が不規則<ul><li>2022.12.31 10:00/2023.01.03 10:00のみ実行するなど</li></ul></li><li>毎日異なる時間に実行する<ul><li>水曜日は10:00、木曜日は03:00に実行するなど</li></ul></li><li>グレゴリオ暦に従わないスケジュール</li></ul></li><li>標準でprovideされているTimeTable<ul><li>EventsTimetable</li><li>CronTriggerTimetable</li></ul></li></ul><p>詳細：<a href=https://airflow.apache.org/docs/apache-airflow/stable/concepts/timetable.html>https://airflow.apache.org/docs/apache-airflow/stable/concepts/timetable.html</a></p><h4 id=独自のtimetable作成方法について>独自のTimetable作成方法について<a hidden class=anchor aria-hidden=true href=#独自のtimetable作成方法について>#</a></h4><p>Airflow2.2から独自のTimeTableを作成することができるようになった。<a href=https://github.com/apache/airflow/blob/0be5c90639dcaa9c6542434160f1f1caf51202a0/airflow/timetables/base.py#L108>airflow.timetables.base.Timetable</a>を拡張すれば良いのだが、以下の関数を含める必要がある。</p><table><thead><tr><th>関数名</th><th>about</th></tr></thead><tbody><tr><td>next_dagrun_info</td><td>スケジュール実行時のデータ間隔を返す</td></tr><tr><td>infer_manual_data_interval</td><td>手動実行時のデータ間隔で返す</td></tr></tbody></table><h4 id=独自のtimetableに指定する関数を作成する>独自のTimetableに指定する関数を作成する。<a hidden class=anchor aria-hidden=true href=#独自のtimetableに指定する関数を作成する>#</a></h4><p>今回は以下のような仕様のTimeTableを作ってみます。</p><ul><li>1日に2回,06:00(①)と16:30(②)にジョブを実行する。実行時に取得するデータの間隔は以下。<ul><li>06:00(①)実行時・・・前日の16:30~当日の06:00</li><li>16:30(②)実行時・・・当日の06:00~当日の16:30</li></ul></li></ul><h5 id=next_dagrun_info関数>next_dagrun_info関数<a hidden class=anchor aria-hidden=true href=#next_dagrun_info関数>#</a></h5><ul><li>データの間隔をDagRunInfo(<code>run_after:DateTime</code>, <code>data_interval:DataInterval</code>)で返す</li><li>parameterに入ってくる<code>restriction:TimeRestriction</code>とはDAGをスケジュールできる期間に関する制限(<code>earliest:DateTime</code>,<code>latest:DateTime</code>,<code>catchup:bool</code>)を持つクラス。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>next_dagrun_info</span>(
</span></span><span style=display:flex><span>    self,
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>,
</span></span><span style=display:flex><span>    last_automated_data_interval: Optional[DataInterval],
</span></span><span style=display:flex><span>    restriction: TimeRestriction,
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> Optional[DagRunInfo]:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> last_automated_data_interval <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:  <span style=color:#75715e># a</span>
</span></span><span style=display:flex><span>        last_start <span style=color:#f92672>=</span> last_automated_data_interval<span style=color:#f92672>.</span>start
</span></span><span style=display:flex><span>        delta <span style=color:#f92672>=</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> last_start<span style=color:#f92672>.</span>hour <span style=color:#f92672>==</span> <span style=color:#ae81ff>6</span>: <span style=color:#75715e># b</span>
</span></span><span style=display:flex><span>            next_start <span style=color:#f92672>=</span> last_start<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC)
</span></span><span style=display:flex><span>            next_end <span style=color:#f92672>=</span> (last_start<span style=color:#f92672>+</span>delta)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>: <span style=color:#75715e># c</span>
</span></span><span style=display:flex><span>            next_start <span style=color:#f92672>=</span> (last_start<span style=color:#f92672>+</span>delta)<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC)
</span></span><span style=display:flex><span>            next_end <span style=color:#f92672>=</span> (last_start<span style=color:#f92672>+</span>delta)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC)
</span></span><span style=display:flex><span>　　<span style=color:#66d9ef>else</span>:  <span style=color:#75715e># d</span>
</span></span><span style=display:flex><span>        next_start <span style=color:#f92672>=</span> restriction<span style=color:#f92672>.</span>earliest
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> next_start <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> restriction<span style=color:#f92672>.</span>catchup:
</span></span><span style=display:flex><span>            next_start <span style=color:#f92672>=</span> max(next_start, DateTime<span style=color:#f92672>.</span>combine(Date<span style=color:#f92672>.</span>today(), Time<span style=color:#f92672>.</span>min)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC))
</span></span><span style=display:flex><span>        next_start <span style=color:#f92672>=</span> next_start<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC)
</span></span><span style=display:flex><span>        next_end <span style=color:#f92672>=</span> next_start<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> restriction<span style=color:#f92672>.</span>latest <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>and</span> next_start <span style=color:#f92672>&gt;</span> restriction<span style=color:#f92672>.</span>latest: <span style=color:#75715e># e</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> DagRunInfo<span style=color:#f92672>.</span>interval(start<span style=color:#f92672>=</span>next_start, end<span style=color:#f92672>=</span>next_end)
</span></span></code></pre></div><p>長い行になりましたが補足すると以下</p><ul><li>初回実行ではない場合(a)<ul><li>前回実行のデータ間隔のStartが06:00の場合(b)<ul><li>今回の実行は①に該当する</li><li>next_startは前回の当日の16:30</li><li>next_endは前回の翌日の06:00</li></ul></li><li>前回実行のデータ間隔のStartが16:30の場合(c)<ul><li>今回の実行は②に該当する</li><li>next_startは前回の翌日の06:00</li><li>next_endは前回の翌日の16:30</li></ul></li></ul></li><li>初回実行の場合(d)<ul><li>DAGをスケジュールできる期間のうちの最早い日を実行日(next_start)として（catchup=Falseの場合、現在の日付を実行日(next_start)とする）<ul><li>next_startは実行日の06:00</li><li>next_endは実行日の16:30</li></ul></li></ul></li><li>またこの時DAGの終了日(restriction.latest)がある場合、その日を越したnext_endを実行しないことを期待している。(e)</li></ul><h4 id=infer_manual_data_interval関数>infer_manual_data_interval関数<a hidden class=anchor aria-hidden=true href=#infer_manual_data_interval関数>#</a></h4><ul><li>スケジュール実行時のデータの間隔をDataInterval(<code>start: DateTime</code>, <code>end:Datetime</code>)で返す。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>infer_manual_data_interval</span>(self, run_after: DateTime) <span style=color:#f92672>-&gt;</span> DataInterval:
</span></span><span style=display:flex><span>    delta <span style=color:#f92672>=</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e># a</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> run_after <span style=color:#f92672>&gt;=</span> run_after<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) <span style=color:#f92672>and</span> run_after <span style=color:#f92672>&lt;=</span> run_after<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>):
</span></span><span style=display:flex><span>        start <span style=color:#f92672>=</span> (run_after<span style=color:#f92672>-</span>delta)<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>, second<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC) 
</span></span><span style=display:flex><span>        end <span style=color:#f92672>=</span> run_after<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, second<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC) 
</span></span><span style=display:flex><span>    <span style=color:#75715e># b</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> run_after <span style=color:#f92672>&gt;=</span> run_after<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>) <span style=color:#f92672>and</span> run_after<span style=color:#f92672>.</span>hour <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>23</span>:
</span></span><span style=display:flex><span>        start <span style=color:#f92672>=</span> run_after<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, second<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC)
</span></span><span style=display:flex><span>        end <span style=color:#f92672>=</span> run_after<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>, second<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC)
</span></span><span style=display:flex><span>    <span style=color:#75715e># c</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        start <span style=color:#f92672>=</span> (run_after<span style=color:#f92672>-</span>delta)<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC)
</span></span><span style=display:flex><span>        end <span style=color:#f92672>=</span> (run_after<span style=color:#f92672>-</span>delta)<span style=color:#f92672>.</span>set(hour<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>, minute<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>)<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>UTC)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> DataInterval(start<span style=color:#f92672>=</span>start, end<span style=color:#f92672>=</span>end)
</span></span></code></pre></div><p>補足すると</p><ul><li>現在時刻が06:00~16:30の間(a)<ul><li>①の実行とされる。</li><li>startは前日の16:30、endは当日の06:00</li></ul></li><li>現在の時刻が16:30~23:00の間(b)<ul><li>②の実行とされる。</li><li>startは当日の06:00、endは当日の16:30</li></ul></li><li>それ以外、深夜の00:00~05:59の間(c)<ul><li>②の実行とされる。</li><li>startは前日の06:00、endは前日の16:30</li></ul></li></ul><h4 id=plugins_folder配下のファイル-7>plugins_folder配下のファイル<a hidden class=anchor aria-hidden=true href=#plugins_folder配下のファイル-7>#</a></h4><ul><li>ファイル構造</li></ul><pre tabindex=0><code>├── __init__.py
└── timetables
    ├── __init__.py
    └── airflow_timetable_template.py
</code></pre><ul><li><code>__init__.py</code></li></ul><pre tabindex=0><code>from airflow.plugins_manager import AirflowPlugin
import timetables

class MyPlugins(AirflowPlugin):
    name = &#34;my_plugins_poyo&#34;
    timetables = [timetables.MyTimeTable]
</code></pre><ul><li><code>timetables/__init__.py</code></li></ul><pre tabindex=0><code>from timetables.airflow_timetable_template import MyTimeTable

__all__ = [&#39;MyTimeTable&#39;]
</code></pre><ul><li><code>timetables/airflow_timetable_template.py</code>
上記で書いた関数をそのまま移植していきます。TimeTable名は<code>MyTimeTable</code></li></ul><pre tabindex=0><code>from datetime import timedelta
from typing import Optional
from pendulum import Date, DateTime, Time, timezone

from airflow.plugins_manager import AirflowPlugin
from airflow.timetables.base import DagRunInfo, DataInterval, TimeRestriction, Timetable

UTC = timezone(&#34;UTC&#34;)

class MyTimeTable(Timetable):

    def infer_manual_data_interval(self, run_after: DateTime) -&gt; DataInterval:
        ・・・

    def next_dagrun_info(
        self,
        *,
        last_automated_data_interval: Optional[DataInterval],
        restriction: TimeRestriction,
    ) -&gt; Optional[DagRunInfo]:
        ・・・
</code></pre><h4 id=作成を反映させる-7>作成を反映させる。<a hidden class=anchor aria-hidden=true href=#作成を反映させる-7>#</a></h4><p>webserverとschedulerの再起動が必要。(TimeTableはschedulerも読み込む必要があるためschedulerも再起動します。再起動しないと<code>TimetableNotRegistered</code>Errorが出ます。)</p><h4 id=作成したtimetableを試してみる>作成したTimeTableを試してみる。<a hidden class=anchor aria-hidden=true href=#作成したtimetableを試してみる>#</a></h4><ul><li>dagのファイル
適当なDAGの<code>timetable</code>引数に作成した<code>MyTimeTable:TimeTable</code>を渡す。importErrorが出てなければ正常に動作しているはず、</li></ul><pre tabindex=0><code>from timetables.airflow_timetable_template import MyTimeTable


@dag(start_date=days_ago(2), timetable=MyTimeTable())
...
</code></pre><ul><li>UIから作成したDAGの確認<ul><li>Scheduleが<code>MyTimeTable</code>になっている</li><li>現在時刻が<code>01/05.14:08</code>の場合<ul><li>次の実行は<code>01/05.16:30</code></li><li>次の次の実行は<code>01/06.06:00</code>。その時のデータ間隔は<code>01/05.16:30~01/06.06:00</code>
<img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/d0837ec8e048-20230105.png alt></li></ul></li></ul></li></ul><hr><h2 id=終わり>終わり<a hidden class=anchor aria-hidden=true href=#終わり>#</a></h2><p>以上AirflowのPluginについて見ていきました。TimeTableについては、AirflowのScheduleについて再度理解する機会になってよかったです。また時間があるときにlistenerやexecutorのカスタムも試してみたいです。</p><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://docs.astronomer.io/learn/scheduling-in-airflow#timetables>https://docs.astronomer.io/learn/scheduling-in-airflow#timetables</a></li><li><a href=https://docs.astronomer.io/learn/using-airflow-plugins>https://docs.astronomer.io/learn/using-airflow-plugins</a></li><li><a href=https://airflow.apache.org/docs/apache-airflow/stable/plugins.html>https://airflow.apache.org/docs/apache-airflow/stable/plugins.html</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://467tn.com/tags/airflow/>Airflow</a></li><li><a href=https://467tn.com/tags/python/>Python</a></li></ul><nav class=paginav><a class=next href=https://467tn.com/post/content7/><span class=title>Next »</span><br><span>AirflowのTaskFlowAPIについて</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share AirflowのPluginsについて on twitter" href="https://twitter.com/intent/tweet/?text=Airflow%e3%81%aePlugins%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6&url=https%3a%2f%2f467tn.com%2fpost%2fcontent8%2f&hashtags=Airflow%2cPython"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://467tn.com>467tn.com</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerHTML="copy";function s(){e.innerHTML="copied!",setTimeout(()=>{e.innerHTML="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>