<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Great Expectationsについて調べてみた | -1.9517320122461623</title><meta name=keywords content="GreatExpectations,Python"><meta name=description content="調べたことと試してみたことについてまとめてあります。"><meta name=author content="Me"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.b524e4b6d6a6efc25a7ca6b852c6483acb761f26eaea8f43a943a7adaf3dec55.css integrity="sha256-tSTkttam78JafKa4UsZIOst2Hybq6o9DqUOnra897FU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><link rel=icon type=image/png sizes=16x16 href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><link rel=icon type=image/png sizes=32x32 href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><link rel=apple-touch-icon href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><link rel=mask-icon href=https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Great Expectationsについて調べてみた"><meta property="og:description" content="調べたことと試してみたことについてまとめてあります。"><meta property="og:type" content="article"><meta property="og:url" content="https://467tn.com/post/content6/"><meta property="og:image" content="https://user-images.githubusercontent.com/60976262/191047722-dd7ed9ad-6e00-4b50-8073-24ae9602b8d6.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-11T11:30:03+00:00"><meta property="article:modified_time" content="2022-12-11T11:30:03+00:00"><meta property="og:site_name" content="467"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://user-images.githubusercontent.com/60976262/191047722-dd7ed9ad-6e00-4b50-8073-24ae9602b8d6.png"><meta name=twitter:title content="Great Expectationsについて調べてみた"><meta name=twitter:description content="調べたことと試してみたことについてまとめてあります。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://467tn.com/post/"},{"@type":"ListItem","position":3,"name":"Great Expectationsについて調べてみた","item":"https://467tn.com/post/content6/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Great Expectationsについて調べてみた","name":"Great Expectationsについて調べてみた","description":"調べたことと試してみたことについてまとめてあります。","keywords":["GreatExpectations","Python"],"articleBody":"この記事はQiita x Code Polaris共催！女性ITエンジニアが作るアドベントカレンダー Advent Calendar 2022の15日目の記事です。Qiitaのアドベントカレンダーに参加するの初めてです（wktk）\n概要 Great Expectations(NOT V2)についてドキュメントを読みながらわかったこと、試したことをまとめる。\nGreat Expectationsとは データのバリデーション(検証)、ドキュメント化、プロファイリング(概要定義)をしてくれるPythonのライブラリ。Superconductive社が開発しているOSS。GXと略されるらしい。\nできること  データの期待の定義(Expectation)  oO(xxxのカラムはNULLがないはずだ！) oO(yyyのカラムはAAもしくはBBしか値が入らないはずだ！) といったような期待の定義。   データの自動的なプロファイリング(Profiling)  「xxxのカラムはNULLがないです」 「yyyのカラムはAAもしくはBBしか値が入らないです」 みたいなデータの概要の自動的な定義   データのバリデーション(Validation)  定義したExpectationが期待通りかの検証。   データのドキュメント化  定義したExpectationをValidationした結果の確認。   さまざまなデータソースやデータストアからのロード  PandasやSparkなどのDataframeや、SQLDatabase及びファイルからのデータロード    何が嬉しいのか データの品質管理ができる -　バグ,過去分データの修正の早期対応。\n似ているもの  dbtのテスト機能。 kubeflowのValidation機能。  できないこと  Pipelineの実行  あくまでPythonのライブラリ。 例えばデータ検証をしたいとなった時、GXの機能を活かしてデータ検証のPipeline（流れ）を作っていくわけだが、作ったPipelineのステップ毎の実行はできるが、全体を通した実行は単体でできない。なので、Airflow,dbt,Prefect,Dagster,KedroのようなDAGを実行するツールと統合すると良い。　   データのバージョン管理  データのバージョン管理するならDVCやQuikltなどを使うと良い。   Pythonの環境以外で最適な状態で動くこと  Pythonでできているので 違う言語やエコシステムから呼び出すとき、CLIから呼び出しなんとかするということもできるが、言語やエコシステムに沿ったものを選択する方が良い、（R-assertR, TensorFlow-TFDV）    データ検証作成の流れ では、GreatExpectationsを使用して例えばデータ検証を作成したいとなったら何をしたら良いの、となるのだが以下の画像が参考になる。  https://docs.greatexpectations.io/assets/images/data_context_does_for_you-df2eca32d0152ead16cccd5d3d226abb.png\n 補足すると\n 1.Setup  「DataContext」の作成 必要あれば）拡張機能(Plugins)の設定やValidation結果などのメタデータを保存する場所の設定   2.Connect to Data  「DataSources」の作成 「BatchRequest」/「RuntimeBatchRequest」の作成   3.Create Expectations  Profilingするなどをして「ExpectationSuite」の作成   4.Validate Data  Validatorを使用して、作成した「Expectation Suite」と「BatchRequest」のペアの検証 CheckPointを使用して、作成した「Expectation Suite」と「BatchRequest」のペアを複数まとめ、検証       用語 何     DataContext プロジェクトのようなもの   DataSources 検証したいデータのConnector   BatchRequest DataSources内のどのデータかの定義(TBL指定)   RuntimeBatchRequest DataSources内のどのデータかの定義(Query指定)   Expectation データに対する期待   ExpectationSuite Expectationの集まり    1についてはCLIから行うことができる 2~4についてはCLIやPython,JupyterNotebookから行うことができる\n試してみる 上記データ検証作成をなぞってみる。\n サンプルデータについて  SQLDB：PostgreSQL   DML  CREATE TABLE sample_poyo ( int_column INTEGER, varchar_column VARCHAR(10), varchar_column2 VARCHAR(10));  DDL  INSERT INTO sample_poyo VALUES (0, 'xxxx', 'zzzz'); INSERT INTO sample_poyo VALUES (1, 'xxxx', 'zzzz'); INSERT INTO sample_poyo VALUES (2, 'xxxx', 'zzzz'); INSERT INTO sample_poyo VALUES (3, 'xxxx', 'zzzz'); INSERT INTO sample_poyo VALUES (4, 'yyyy', 'zzzz'); INSERT INTO sample_poyo VALUES (5, 'yyyy', 'zzzz'); INSERT INTO sample_poyo VALUES (6, 'yyyy', 'zzzz'); INSERT INTO sample_poyo VALUES (7, 'yyyy', 'zzzz');  データ内容   int_column | varchar_column | varchar_column2 ------------+----------------+----------------- 0 | xxxx | zzzz 1 | xxxx | zzzz 2 | xxxx | zzzz 3 | xxxx | zzzz 4 | yyyy | zzzz 5 | yyyy | zzzz 6 | yyyy | zzzz 7 | yyyy | zzzz JupyterNotebookとCLIを使用してインタラクティブに上記データ検証作成をすることもできますが、やりたいことの都合上ここにおいては基本的にPythonで完結するやり方でかいていきます。 手っ取り早くコードを見たい方は1.Setupを行い、https://github.com/srn221B/sample_gxこちらを参考にどうぞ。\n1.SetUp インストール FYI: https://docs.greatexpectations.io/docs/guides/setup/installation/local/\npip install great_expectations DataContextの作成 プロジェクト(DataContext)を作成する。\ngreat_expectations init Using v3 (Batch Request) API ___ _ ___ _ _ _ / __|_ _ ___ __ _| |_ | __|_ ___ __ ___ __| |_ __ _| |_(_)___ _ _ ___ | (_ | '_/ -_) _` | _| | _|\\ \\ / '_ \\/ -_) _| _/ _` | _| / _ \\ ' \\(_-Enterするとgreat_expectationsといいうディレクトリができ、構成ファイルができる。\n. ├── checkpoints ├── expectations ├── great_expectations.yml ├── plugins │ └── custom_data_docs │ ├── renderers │ ├── styles │ │ └── data_docs_custom_styles.css │ └── views ├── profilers └── uncommitted # バージョン管理すべきではないコードが入っている ├── config_variables.yml ├── data_docs └── validations 2.Connect to Data DataSourceを作成する。  https://docs.greatexpectations.io/assets/images/datasource_works_for_you-4a7ec1df1f7383cbb399dcac296f8895.png\n DataSourceは主にExecution EngineとDataConnectorから成っている。今回はPostgreSQLに接続するためのDataSourceを作成するのでこちらのページを参考にしながら以下のように作成する。\nimport great_expectations as ge context = ge.get_context()  ps_user_name='' ps_password='' ps_host='' ps_port='' ps_db=''  datasource_config = {  \"name\": \"my_datasource\",  \"class_name\": \"Datasource\",  \"execution_engine\": {  \"class_name\": \"SqlAlchemyExecutionEngine\",  \"connection_string\": \\ \tf\"postgresql+psycopg2://{ps_user_name}:{ps_password}@{ps_host}:{ps_port}/{ps_db}\",  },  \"data_connectors\": {  \"default_runtime_data_connector_name\": {  \"class_name\": \"RuntimeDataConnector\",  \"batch_identifiers\": [\"default_identifier_name\"],  },  \"default_inferred_data_connector_name\": {  \"class_name\": \"InferredAssetSqlDataConnector\",  \"include_schema_name\": True,  },  }, } DataSourceをテストしたいときはyamlをdumpしてtest_yaml_configに渡せばテストできる。\ncontext.test_yaml_config(yaml.dump(datasource_config)) 作成したDataSourceを追加する。 context.add_datasource(**datasource_config) 追加すると「great_expectations.yml」のdatasourcesにもmy_datasourceの内容が反映されていることが確認できる。\ndatasources: my_datasource: ・・・ BatchRequestを作成する。 Datasource内のどのデータを検証するかをBatchRequestとして作成する。今回はテーブル内の全データなので以下のようにかく。\nfrom great_expectations.core.batch import BatchRequest tbl_name=\"public.sample_poyo\" batch_request = BatchRequest(  datasource_name=\"my_datasource\",  data_connector_name=\"default_inferred_data_connector_name\",  data_asset_name=tbl_name, ) 3.Create Expectations いきなりExpectationを作成しても良いが、データを理解するためにProfilingをしてみる。\nProfiling)ExpectationSuite/Validatorの作成 Expectationを追加するためのExpectationSuiteと、ExpectationSuiteとBatchRequestのペアをValidatorに定義する。\nsuite_name = \"profiling_suite\" context.create_expectation_suite(  suite_name, overwrite_existing=True ) validator = context.get_validator(  batch_request=batch_request,  expectation_suite_name=suite_name ) Profiling)Profilerを作成しProfilingしてみる。 UseConfigurableProfilerへValidatorを渡すとProfilerが作成できる。また、Profilerには以下が設定できる。\n- excluded_expectations: List[str] - 除外するExpectation - ignored_columns: List[str] - 除外するcolumn - not_null_only: bool - デフォルトでNULLかどうかを評価するExpectationがNULL率によって入るわけだが,こちらをTrueにするとNULL率に関係なくNOT NULLがmustなExpectationが追加される。 - primary_or_compound_key: List[str] - 主キーや複合キーを指定すると、uniqueかどうか評価するExpectationが追加される。 - table_expectations_only - こちらをTrueにすると、tableレベルのExpectationのみを作成する。 - そのほか：https://docs.greatexpectations.io/docs/guides/expectations/how_to_create_and_edit_expectations_with_a_profiler#optional-parameters 今回は、ignored_columnsでcolumn「varchar_column2」の除外を行う。\nfrom great_expectations.profile.user_configurable_profiler \\  import UserConfigurableProfiler  profiler = UserConfigurableProfiler( \tprofile_dataset=validator, \tignored_columns=['varchar_column2'] \t) expectation_suit = profiler.build_suite() expectations = expectation_suit['expectations'] for expectation in expectations:  print('---')  print('expectation_type: ' + expectation.expectation_type)  print('kwargs: ' + str(expectation.kwargs)) 実行すると以下のようなProfiling結果を見ることができる\nexpectation_type: expect_column_values_to_not_be_null kwargs: {'column': 'int_column'} --- expectation_type: expect_column_values_to_not_be_null kwargs: {'column': 'varchar_column'} --- expectation_type: expect_column_values_to_be_in_set kwargs: {'value_set': ['xxxx', 'yyyy'], 'column': 'varchar_column'}  1つ目と2つ目はcolumn「int_column」「varchar_column」にはNULLが入らない。 3つ目はcolumn「varchar_column」には’xxxx’か’yyyy’のvalueが入る。  という意味だ。 各expectation_typeやそれぞれのkwargsについてはこちらのページから調べることができる。\nExpectationの作成 データについて理解できたので、Expectationを作成してみる。具体的にはProfiling結果を参考に以下のExpectationをここでは定義する。\n column「int_column」はNULLが入らない。 column「int_column」は0~7のvalueである。 column「varchar_column」はNULLが入らない。 column「varchar_column」は’xxxx’か’yyyy’のvalueが入る。  ExpectationConfigurationに渡す、expectation_typeとkwargsについてはProfilingした時と同じこちらのページを参考に行う。\n# 新規suiteとvalidatorの作成 suite_name = \"ex_suite\" context.create_expectation_suite(  suite_name, overwrite_existing=True ) validator = context.get_validator(  batch_request=batch_request,  expectation_suite_name=suite_name )  # Expectationの作成 from great_expectations.core.expectation_configuration import ExpectationConfiguration e1 = ExpectationConfiguration( # column「int_column」はNULLが入らない。  expectation_type=\"expect_column_values_to_not_be_null\",  kwargs={  \"column\": \"int_column\"} ) e2 = ExpectationConfiguration(　# column「int_column」は0~7のvalueである。  expectation_type=\"expect_column_values_to_be_between\",  kwargs={  \"column\": \"int_column\",  \"min_value\": 0,  \"max_value\": 7} ) e3 = ExpectationConfiguration( # column「varchar_column」はNULLが入らない。  expectation_type=\"expect_column_values_to_not_be_null\",  kwargs={  \"column\": \"varchar_column\"} ) e4 = ExpectationConfiguration( # column「varchar_column」は'xxxx'か'yyyy'のvalueが入る。  expectation_type=\"expect_column_values_to_be_in_set\",  kwargs={  \"column\": \"varchar_column\",  \"value_set\": ['xxxx', 'yyyy']} ) ExpectationSuiteへExpectationの追加 expectationをまとめて渡すexpectation_configurationsは、 version0.15.*から使えるみたい。\nsuite.add_expectation_configurations(  expectation_configurations=[e1,e2,e3,e4]) context.save_expectation_suite(suite, \"test_suite2\") Validatorを作成しValidateしてみる。 batch_requestとexpectation_suiteの準備ができたので、Validatorを作成してValidateしてみる。\nres = validator.validate() 結果を表示してみる。 for r in res['results']:  print('---')  print(f'expectation_type: {r.expectation_config.expectation_type}')  print(f'kwargs: {r.expectation_config.kwargs}')  print(f'success: {r.success}')  print(f'result: {r.result}') 上記を実行すると以下のような実行結果が見える。\n--- expectation_type: expect_column_values_to_not_be_null kwargs: {'column': 'int_column', 'batch_id': 'b431836ba46465a1106559d8e5ff2656'} success: True result: {'element_count': 8, 'unexpected_count': 0, 'unexpected_percent': 0.0, 'partial_unexpected_list': []} --- expectation_type: expect_column_values_to_be_between kwargs: {'column': 'int_column', 'max_value': 7, 'min_value': 0, 'batch_id': 'b431836ba46465a1106559d8e5ff2656'} success: True result: {'element_count': 8, 'unexpected_count': 0, 'unexpected_percent': 0.0, 'partial_unexpected_list': [], 'missing_count': 0, 'missing_percent': 0.0, 'unexpected_percent_total': 0.0, 'unexpected_percent_nonmissing': 0.0} --- expectation_type: expect_column_values_to_not_be_null kwargs: {'column': 'varchar_column', 'batch_id': 'b431836ba46465a1106559d8e5ff2656'} success: True result: {'element_count': 8, 'unexpected_count': 0, 'unexpected_percent': 0.0, 'partial_unexpected_list': []} --- expectation_type: expect_column_values_to_be_in_set kwargs: {'column': 'varchar_column', 'value_set': ['xxxx', 'yyyy'], 'batch_id': 'b431836ba46465a1106559d8e5ff2656'} success: True result: {'element_count': 8, 'unexpected_count': 0, 'unexpected_percent': 0.0, 'partial_unexpected_list': [], 'missing_count': 0, 'missing_percent': 0.0, 'unexpected_percent_total': 0.0, 'unexpected_percent_nonmissing': 0.0} 試しに以下の行を追加して、『2. column「int_column」は0~7のvalueである。』に反するようにしてみる。\n DDL  INSERT INTO sample_poyo VALUES (9, 'xxxx', 'zzzz');  データ内容   int_column | varchar_column | varchar_column2 ------------+----------------+----------------- 0 | xxxx | zzzz 1 | xxxx | zzzz 2 | xxxx | zzzz 3 | xxxx | zzzz 4 | yyyy | zzzz 5 | yyyy | zzzz 6 | yyyy | zzzz 7 | yyyy | zzzz 9 | yyyy | zzzz そうすると次のように結果が変わる。検証対象９行(element_count)のうち1行(unexpected_count)が期待通りではない、という意味だ。\nexpectation_type: expect_column_values_to_be_between kwargs: {'column': 'int_column', 'max_value': 7, 'min_value': 0, 'batch_id': 'b431836ba46465a1106559d8e5ff2656'} success: False result: {'element_count': 9, 'unexpected_count': 1, 'unexpected_percent': 11.11111111111111, 'partial_unexpected_list': [9], 'missing_count': 0, 'missing_percent': 0.0, 'unexpected_percent_total': 11.11111111111111, 'unexpected_percent_nonmissing': 11.11111111111111} つまづいたポイント 今回指定したように、SqlAlchemyを活用したDataSourceを作成したい場合(execution_engine.class_nameにSqlAlchemyExecutionEngineを指定したDataSourceの場合)、create_engineする時の引数は「connection_string」しか現在渡せないようです。 https://github.com/great-expectations/great_expectations/issues/6226\n終わりに GreatExpectationsとは何か、およびPythonを使った使い方について説明していきました。 今回は使いませんでしたがRuntimeBatchRequestを使えば検証したいデータを都度柔軟に指定できるところ、Queryを書かずにExpectationを定義できるところ、及びコードベースでそれらが管理できるところが個人的に良いかなと思っています。\n","wordCount":"848","inLanguage":"en","image":"https://user-images.githubusercontent.com/60976262/191047722-dd7ed9ad-6e00-4b50-8073-24ae9602b8d6.png","datePublished":"2022-12-11T11:30:03Z","dateModified":"2022-12-11T11:30:03Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://467tn.com/post/content6/"},"publisher":{"@type":"Organization","name":"-1.9517320122461623","logo":{"@type":"ImageObject","url":"https://user-images.githubusercontent.com/60976262/190914441-404cb19b-540f-4178-a89d-8f89ab1e187c.png"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://467tn.com accesskey=h title="  (Alt + H)"><img src=https://467tn.com/home.png alt aria-label=logo height=35></a><div class=logo-switches></div></div><ul id=menu><li><a href=https://467tn.com/ title=whoami><span>whoami</span></a></li><li><a href=https://467tn.com/archives/ title=archive><span>archive</span></a></li><li><a href=https://467tn.com/tags/ title=tags><span>tags</span></a></li><li><a href=https://filmarks.com/users/467 title=filmarks><span>filmarks</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://s6n.hatenablog.com/ title=travels><span>travels</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://zenn.dev/467 title=zenn><span>zenn</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://467tn.com>Home</a>&nbsp;»&nbsp;<a href=https://467tn.com/post/>Posts</a></div><h1 class=post-title>Great Expectationsについて調べてみた</h1><div class=post-description>調べたことと試してみたことについてまとめてあります。</div><div class=post-meta><span title="2022-12-11 11:30:03 +0000 +0000">December 11, 2022</span>&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/srn221B/blog/tree/master/content/post/content6.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#great-expectationsとは>Great Expectationsとは</a><ul><li><a href=#できること>できること</a></li><li><a href=#何が嬉しいのか>何が嬉しいのか</a></li><li><a href=#似ているもの>似ているもの</a></li><li><a href=#できないこと>できないこと</a></li><li><a href=#データ検証作成の流れ>データ検証作成の流れ</a></li></ul></li><li><a href=#試してみる>試してみる</a><ul><li><a href=#1setup>1.SetUp</a></li><li><a href=#2connect-to-data>2.Connect to Data</a></li><li><a href=#3create-expectations>3.Create Expectations</a></li></ul></li><li><a href=#つまづいたポイント>つまづいたポイント</a></li><li><a href=#終わりに>終わりに</a></li></ul></nav></div></details></div><div class=post-content><p>この記事は<a href=https://qiita.com/advent-calendar/2022/qiita-code-polaris>Qiita x Code Polaris共催！女性ITエンジニアが作るアドベントカレンダー Advent Calendar 2022</a>の15日目の記事です。Qiitaのアドベントカレンダーに参加するの初めてです（wktk）</p><h2 id=概要>概要<a hidden class=anchor aria-hidden=true href=#概要>#</a></h2><p><a href=https://docs.greatexpectations.io/docs/>Great Expectations</a>(NOT V2)についてドキュメントを読みながらわかったこと、試したことをまとめる。</p><h2 id=great-expectationsとは>Great Expectationsとは<a hidden class=anchor aria-hidden=true href=#great-expectationsとは>#</a></h2><p>データのバリデーション(検証)、ドキュメント化、プロファイリング(概要定義)をしてくれるPythonのライブラリ。Superconductive社が開発しているOSS。GXと略されるらしい。</p><h3 id=できること>できること<a hidden class=anchor aria-hidden=true href=#できること>#</a></h3><ul><li><strong>データの期待の定義(Expectation)</strong><ul><li>oO(xxxのカラムはNULLがないはずだ！)</li><li>oO(yyyのカラムはAAもしくはBBしか値が入らないはずだ！)</li><li>といったような期待の定義。</li></ul></li><li><strong>データの自動的なプロファイリング(Profiling)</strong><ul><li>「xxxのカラムはNULLがないです」</li><li>「yyyのカラムはAAもしくはBBしか値が入らないです」</li><li>みたいなデータの概要の自動的な定義</li></ul></li><li><strong>データのバリデーション(Validation)</strong><ul><li>定義したExpectationが期待通りかの検証。</li></ul></li><li><strong>データのドキュメント化</strong><ul><li>定義したExpectationをValidationした結果の確認。</li></ul></li><li><strong>さまざまなデータソースやデータストアからのロード</strong><ul><li>PandasやSparkなどのDataframeや、SQLDatabase及びファイルからのデータロード</li></ul></li></ul><h3 id=何が嬉しいのか>何が嬉しいのか<a hidden class=anchor aria-hidden=true href=#何が嬉しいのか>#</a></h3><p>データの品質管理ができる ->　バグ,過去分データの修正の早期対応。</p><h3 id=似ているもの>似ているもの<a hidden class=anchor aria-hidden=true href=#似ているもの>#</a></h3><ul><li><a href=https://www.getdbt.com/>dbt</a>のテスト機能。</li><li><a href=https://www.kubeflow.org/>kubeflow</a>のValidation機能。</li></ul><h3 id=できないこと>できないこと<a hidden class=anchor aria-hidden=true href=#できないこと>#</a></h3><ul><li><strong>Pipelineの実行</strong><ul><li>あくまでPythonのライブラリ。</li><li>例えばデータ検証をしたいとなった時、GXの機能を活かしてデータ検証のPipeline（流れ）を作っていくわけだが、作ったPipelineのステップ毎の実行はできるが、全体を通した実行は単体でできない。なので、Airflow,dbt,Prefect,Dagster,KedroのようなDAGを実行するツールと統合すると良い。　</li></ul></li><li><strong>データのバージョン管理</strong><ul><li>データのバージョン管理するならDVCやQuikltなどを使うと良い。</li></ul></li><li><strong>Pythonの環境以外で最適な状態で動くこと</strong><ul><li>Pythonでできているので</li><li>違う言語やエコシステムから呼び出すとき、CLIから呼び出しなんとかするということもできるが、言語やエコシステムに沿ったものを選択する方が良い、（R->assertR, TensorFlow->TFDV）</li></ul></li></ul><h3 id=データ検証作成の流れ>データ検証作成の流れ<a hidden class=anchor aria-hidden=true href=#データ検証作成の流れ>#</a></h3><p>では、GreatExpectationsを使用して例えばデータ検証を作成したいとなったら何をしたら良いの、となるのだが以下の画像が参考になる。
<img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/d392dd1323a2-20221205.png alt></p><blockquote><p><a href=https://docs.greatexpectations.io/assets/images/data_context_does_for_you-df2eca32d0152ead16cccd5d3d226abb.png>https://docs.greatexpectations.io/assets/images/data_context_does_for_you-df2eca32d0152ead16cccd5d3d226abb.png</a></p></blockquote><p>補足すると</p><ul><li>1.Setup<ul><li>「DataContext」の作成</li><li>必要あれば）拡張機能(Plugins)の設定やValidation結果などのメタデータを保存する場所の設定</li></ul></li><li>2.Connect to Data<ul><li>「DataSources」の作成</li><li>「BatchRequest」/「RuntimeBatchRequest」の作成</li></ul></li><li>3.Create Expectations<ul><li>Profilingするなどをして「ExpectationSuite」の作成</li></ul></li><li>4.Validate Data<ul><li>Validatorを使用して、作成した「Expectation Suite」と「BatchRequest」のペアの検証</li><li>CheckPointを使用して、作成した「Expectation Suite」と「BatchRequest」のペアを複数まとめ、検証</li></ul></li></ul><table><thead><tr><th>用語</th><th>何</th></tr></thead><tbody><tr><td>DataContext</td><td>プロジェクトのようなもの</td></tr><tr><td>DataSources</td><td>検証したいデータのConnector</td></tr><tr><td>BatchRequest</td><td>DataSources内のどのデータかの定義(TBL指定)</td></tr><tr><td>RuntimeBatchRequest</td><td>DataSources内のどのデータかの定義(Query指定)</td></tr><tr><td>Expectation</td><td>データに対する期待</td></tr><tr><td>ExpectationSuite</td><td>Expectationの集まり</td></tr></tbody></table><p>1についてはCLIから行うことができる
2~4についてはCLIやPython,JupyterNotebookから行うことができる</p><h2 id=試してみる>試してみる<a hidden class=anchor aria-hidden=true href=#試してみる>#</a></h2><p>上記データ検証作成をなぞってみる。</p><ul><li>サンプルデータについて<ul><li>SQLDB：PostgreSQL</li></ul></li><li>DML</li></ul><pre tabindex=0><code>CREATE TABLE sample_poyo (
  int_column INTEGER, 
  varchar_column VARCHAR(10),
  varchar_column2 VARCHAR(10));
</code></pre><ul><li>DDL</li></ul><pre tabindex=0><code>INSERT INTO sample_poyo VALUES (0, &#39;xxxx&#39;, &#39;zzzz&#39;);
INSERT INTO sample_poyo VALUES (1, &#39;xxxx&#39;, &#39;zzzz&#39;);
INSERT INTO sample_poyo VALUES (2, &#39;xxxx&#39;, &#39;zzzz&#39;);
INSERT INTO sample_poyo VALUES (3, &#39;xxxx&#39;, &#39;zzzz&#39;);
INSERT INTO sample_poyo VALUES (4, &#39;yyyy&#39;, &#39;zzzz&#39;);
INSERT INTO sample_poyo VALUES (5, &#39;yyyy&#39;, &#39;zzzz&#39;);
INSERT INTO sample_poyo VALUES (6, &#39;yyyy&#39;, &#39;zzzz&#39;);
INSERT INTO sample_poyo VALUES (7, &#39;yyyy&#39;, &#39;zzzz&#39;);
</code></pre><ul><li>データ内容</li></ul><pre tabindex=0><code> int_column | varchar_column | varchar_column2 
------------+----------------+-----------------
         0 | xxxx           | zzzz
         1 | xxxx           | zzzz
         2 | xxxx           | zzzz
         3 | xxxx           | zzzz
         4 | yyyy           | zzzz
         5 | yyyy           | zzzz
         6 | yyyy           | zzzz
         7 | yyyy           | zzzz
</code></pre><p>JupyterNotebookとCLIを使用してインタラクティブに上記データ検証作成をすることもできますが、やりたいことの都合上ここにおいては<strong>基本的にPythonで完結するやり方でかいていきます。</strong>
手っ取り早くコードを見たい方は1.Setupを行い、<a href=https://github.com/srn221B/sample_gx>https://github.com/srn221B/sample_gx</a>こちらを参考にどうぞ。</p><h3 id=1setup>1.SetUp<a hidden class=anchor aria-hidden=true href=#1setup>#</a></h3><h4 id=インストール>インストール<a hidden class=anchor aria-hidden=true href=#インストール>#</a></h4><p>FYI: <a href=https://docs.greatexpectations.io/docs/guides/setup/installation/local/>https://docs.greatexpectations.io/docs/guides/setup/installation/local/</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install great_expectations
</span></span></code></pre></div><h4 id=datacontextの作成>DataContextの作成<a hidden class=anchor aria-hidden=true href=#datacontextの作成>#</a></h4><p>プロジェクト(DataContext)を作成する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>great_expectations init
</span></span></code></pre></div><pre tabindex=0><code>Using v3 (Batch Request) API

  ___              _     ___                  _        _   _
 / __|_ _ ___ __ _| |_  | __|_ ___ __  ___ __| |_ __ _| |_(_)___ _ _  ___
| (_ | &#39;_/ -_) _` |  _| | _|\ \ / &#39;_ \/ -_) _|  _/ _` |  _| / _ \ &#39; \(_-&lt;
 \___|_| \___\__,_|\__| |___/_\_\ .__/\___\__|\__\__,_|\__|_\___/_||_/__/
                                |_|
             ~ Always know what to expect from your data ~

Let&#39;s create a new Data Context to hold your project configuration.

Great Expectations will create a new directory with the following structure:

    great_expectations
    |-- great_expectations.yml
    |-- expectations
    |-- checkpoints
    |-- plugins
    |-- .gitignore
    |-- uncommitted
        |-- config_variables.yml
        |-- data_docs
        |-- validations

OK to proceed? [Y/n]: &lt;press Enter&gt;
</code></pre><p>Enterするとgreat_expectationsといいうディレクトリができ、構成ファイルができる。</p><pre tabindex=0><code>.
├── checkpoints
├── expectations
├── great_expectations.yml
├── plugins
│   └── custom_data_docs
│       ├── renderers
│       ├── styles
│       │   └── data_docs_custom_styles.css
│       └── views
├── profilers
└── uncommitted # バージョン管理すべきではないコードが入っている
    ├── config_variables.yml
    ├── data_docs
    └── validations
</code></pre><h3 id=2connect-to-data>2.Connect to Data<a hidden class=anchor aria-hidden=true href=#2connect-to-data>#</a></h3><h4 id=datasourceを作成する>DataSourceを作成する。<a hidden class=anchor aria-hidden=true href=#datasourceを作成する>#</a></h4><p><img loading=lazy src=https://storage.googleapis.com/zenn-user-upload/c42b612fc635-20221205.png alt></p><blockquote><p><a href=https://docs.greatexpectations.io/assets/images/datasource_works_for_you-4a7ec1df1f7383cbb399dcac296f8895.png>https://docs.greatexpectations.io/assets/images/datasource_works_for_you-4a7ec1df1f7383cbb399dcac296f8895.png</a></p></blockquote><p>DataSourceは主に<a href=https://github.com/great-expectations/great_expectations/blob/e5249f4b445a22e015cbcb07f6e45ecf516e698f/great_expectations/execution_engine/execution_engine.py#L197>Execution Engine</a>と<a href=https://github.com/great-expectations/great_expectations/blob/e5249f4b445a22e015cbcb07f6e45ecf516e698f/great_expectations/datasource/data_connector/data_connector.py#L20>DataConnector</a>から成っている。今回はPostgreSQLに接続するためのDataSourceを作成するので<a href=https://docs.greatexpectations.io/docs/guides/connecting_to_your_data/database/postgres>こちらのページ</a>を参考にしながら以下のように作成する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> great_expectations <span style=color:#66d9ef>as</span> ge
</span></span><span style=display:flex><span>context <span style=color:#f92672>=</span> ge<span style=color:#f92672>.</span>get_context()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ps_user_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>ps_password<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>ps_host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>ps_port<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>ps_db<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>datasource_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;my_datasource&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;class_name&#34;</span>: <span style=color:#e6db74>&#34;Datasource&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;execution_engine&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;class_name&#34;</span>: <span style=color:#e6db74>&#34;SqlAlchemyExecutionEngine&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;connection_string&#34;</span>: \
</span></span><span style=display:flex><span>		<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;postgresql+psycopg2://</span><span style=color:#e6db74>{</span>ps_user_name<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>ps_password<span style=color:#e6db74>}</span><span style=color:#e6db74>@</span><span style=color:#e6db74>{</span>ps_host<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>ps_port<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>ps_db<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;data_connectors&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;default_runtime_data_connector_name&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;class_name&#34;</span>: <span style=color:#e6db74>&#34;RuntimeDataConnector&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;batch_identifiers&#34;</span>: [<span style=color:#e6db74>&#34;default_identifier_name&#34;</span>],
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;default_inferred_data_connector_name&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;class_name&#34;</span>: <span style=color:#e6db74>&#34;InferredAssetSqlDataConnector&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;include_schema_name&#34;</span>: <span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>DataSourceをテストしたいときはyamlをdumpしてtest_yaml_configに渡せばテストできる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>context<span style=color:#f92672>.</span>test_yaml_config(yaml<span style=color:#f92672>.</span>dump(datasource_config))
</span></span></code></pre></div><h4 id=作成したdatasourceを追加する>作成したDataSourceを追加する。<a hidden class=anchor aria-hidden=true href=#作成したdatasourceを追加する>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>context<span style=color:#f92672>.</span>add_datasource(<span style=color:#f92672>**</span>datasource_config)
</span></span></code></pre></div><p>追加すると「great_expectations.yml」の<code>datasources</code>にも<code>my_datasource</code>の内容が反映されていることが確認できる。</p><pre tabindex=0><code>datasources:
  my_datasource:
・・・
</code></pre><h4 id=batchrequestを作成する>BatchRequestを作成する。<a hidden class=anchor aria-hidden=true href=#batchrequestを作成する>#</a></h4><p>Datasource内のどのデータを検証するかを<a href=https://github.com/great-expectations/great_expectations/blob/e5249f4b445a22e015cbcb07f6e45ecf516e698f/great_expectations/core/batch.py#L390>BatchRequest</a>として作成する。今回はテーブル内の全データなので以下のようにかく。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> great_expectations.core.batch <span style=color:#f92672>import</span> BatchRequest
</span></span><span style=display:flex><span>tbl_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;public.sample_poyo&#34;</span>
</span></span><span style=display:flex><span>batch_request <span style=color:#f92672>=</span> BatchRequest(
</span></span><span style=display:flex><span>    datasource_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;my_datasource&#34;</span>,
</span></span><span style=display:flex><span>    data_connector_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;default_inferred_data_connector_name&#34;</span>,
</span></span><span style=display:flex><span>    data_asset_name<span style=color:#f92672>=</span>tbl_name,
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=3create-expectations>3.Create Expectations<a hidden class=anchor aria-hidden=true href=#3create-expectations>#</a></h3><p>いきなりExpectationを作成しても良いが、データを理解するためにProfilingをしてみる。</p><h4 id=profilingexpectationsuitevalidatorの作成>Profiling)ExpectationSuite/Validatorの作成<a hidden class=anchor aria-hidden=true href=#profilingexpectationsuitevalidatorの作成>#</a></h4><p>Expectationを追加するためのExpectationSuiteと、ExpectationSuiteとBatchRequestのペアを<a href=https://github.com/great-expectations/great_expectations/blob/e5249f4b445a22e015cbcb07f6e45ecf516e698f/great_expectations/validator/validator.py#L162>Validator</a>に定義する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>suite_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;profiling_suite&#34;</span>
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>create_expectation_suite(
</span></span><span style=display:flex><span>    suite_name, overwrite_existing<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>validator <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span>get_validator(
</span></span><span style=display:flex><span>    batch_request<span style=color:#f92672>=</span>batch_request,
</span></span><span style=display:flex><span>    expectation_suite_name<span style=color:#f92672>=</span>suite_name
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h4 id=profilingprofilerを作成しprofilingしてみる>Profiling)Profilerを作成しProfilingしてみる。<a hidden class=anchor aria-hidden=true href=#profilingprofilerを作成しprofilingしてみる>#</a></h4><p><a href=https://github.com/great-expectations/great_expectations/blob/e5249f4b445a22e015cbcb07f6e45ecf516e698f/great_expectations/profile/user_configurable_profiler.py#L39>UseConfigurableProfiler</a>へValidatorを渡すとProfilerが作成できる。また、Profilerには以下が設定できる。</p><pre tabindex=0><code>- excluded_expectations: List[str]
	- 　除外するExpectation
- ignored_columns: List[str]
	- 除外するcolumn
- not_null_only: bool
	- デフォルトでNULLかどうかを評価するExpectationがNULL率によって入るわけだが,こちらをTrueにするとNULL率に関係なくNOT NULLがmustなExpectationが追加される。
- primary_or_compound_key: List[str]
	- 主キーや複合キーを指定すると、uniqueかどうか評価するExpectationが追加される。
- table_expectations_only
	- こちらをTrueにすると、tableレベルのExpectationのみを作成する。
- そのほか：https://docs.greatexpectations.io/docs/guides/expectations/how_to_create_and_edit_expectations_with_a_profiler#optional-parameters
</code></pre><p>今回は、ignored_columnsでcolumn「varchar_column2」の除外を行う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> great_expectations.profile.user_configurable_profiler \
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> UserConfigurableProfiler
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>profiler <span style=color:#f92672>=</span> UserConfigurableProfiler(
</span></span><span style=display:flex><span>	profile_dataset<span style=color:#f92672>=</span>validator,
</span></span><span style=display:flex><span>	ignored_columns<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;varchar_column2&#39;</span>]
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>expectation_suit <span style=color:#f92672>=</span> profiler<span style=color:#f92672>.</span>build_suite()
</span></span><span style=display:flex><span>expectations <span style=color:#f92672>=</span> expectation_suit[<span style=color:#e6db74>&#39;expectations&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> expectation <span style=color:#f92672>in</span> expectations:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;---&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;expectation_type: &#39;</span> <span style=color:#f92672>+</span> expectation<span style=color:#f92672>.</span>expectation_type)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;kwargs: &#39;</span> <span style=color:#f92672>+</span> str(expectation<span style=color:#f92672>.</span>kwargs))
</span></span></code></pre></div><p>実行すると以下のようなProfiling結果を見ることができる</p><pre tabindex=0><code>expectation_type: expect_column_values_to_not_be_null
kwargs: {&#39;column&#39;: &#39;int_column&#39;}
---
expectation_type: expect_column_values_to_not_be_null
kwargs: {&#39;column&#39;: &#39;varchar_column&#39;}
---
expectation_type: expect_column_values_to_be_in_set
kwargs: {&#39;value_set&#39;: [&#39;xxxx&#39;, &#39;yyyy&#39;], &#39;column&#39;: &#39;varchar_column&#39;}
</code></pre><ul><li>1つ目と2つ目はcolumn「int_column」「varchar_column」にはNULLが入らない。</li><li>3つ目はcolumn「varchar_column」には&rsquo;xxxx&rsquo;か&rsquo;yyyy&rsquo;のvalueが入る。</li></ul><p>という意味だ。
各expectation_typeやそれぞれのkwargsについては<a href="https://greatexpectations.io/expectations/?filterType=Backend%20support&gotoPage=1&showFilters=false&viewType=Summary">こちらのページ</a>から調べることができる。</p><h4 id=expectationの作成>Expectationの作成<a hidden class=anchor aria-hidden=true href=#expectationの作成>#</a></h4><p>データについて理解できたので、Expectationを作成してみる。具体的にはProfiling結果を参考に以下のExpectationをここでは定義する。</p><ol><li>column「int_column」はNULLが入らない。</li><li>column「int_column」は0~7のvalueである。</li><li>column「varchar_column」はNULLが入らない。</li><li>column「varchar_column」は&rsquo;xxxx&rsquo;か&rsquo;yyyy&rsquo;のvalueが入る。</li></ol><p><a href=https://github.com/great-expectations/great_expectations/blob/9fed397a318f5fa773f274f11db2116b65b1dcc9/great_expectations/core/expectation_configuration.py#L96>ExpectationConfiguration</a>に渡す、expectation_typeとkwargsについてはProfilingした時と同じ<a href="https://greatexpectations.io/expectations/?filterType=Backend%20support&gotoPage=1&showFilters=false&viewType=Summary">こちらのページ</a>を参考に行う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 新規suiteとvalidatorの作成</span>
</span></span><span style=display:flex><span>suite_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ex_suite&#34;</span>
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>create_expectation_suite(
</span></span><span style=display:flex><span>    suite_name, overwrite_existing<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>validator <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span>get_validator(
</span></span><span style=display:flex><span>    batch_request<span style=color:#f92672>=</span>batch_request,
</span></span><span style=display:flex><span>    expectation_suite_name<span style=color:#f92672>=</span>suite_name
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Expectationの作成</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> great_expectations.core.expectation_configuration <span style=color:#f92672>import</span> ExpectationConfiguration
</span></span><span style=display:flex><span>e1 <span style=color:#f92672>=</span> ExpectationConfiguration( <span style=color:#75715e># column「int_column」はNULLが入らない。</span>
</span></span><span style=display:flex><span>   expectation_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;expect_column_values_to_not_be_null&#34;</span>,
</span></span><span style=display:flex><span>   kwargs<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;column&#34;</span>: <span style=color:#e6db74>&#34;int_column&#34;</span>}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>e2 <span style=color:#f92672>=</span> ExpectationConfiguration(　<span style=color:#75715e># column「int_column」は0~7のvalueである。</span>
</span></span><span style=display:flex><span>   expectation_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;expect_column_values_to_be_between&#34;</span>,
</span></span><span style=display:flex><span>   kwargs<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;column&#34;</span>: <span style=color:#e6db74>&#34;int_column&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;min_value&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;max_value&#34;</span>: <span style=color:#ae81ff>7</span>}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>e3 <span style=color:#f92672>=</span> ExpectationConfiguration( <span style=color:#75715e># column「varchar_column」はNULLが入らない。</span>
</span></span><span style=display:flex><span>   expectation_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;expect_column_values_to_not_be_null&#34;</span>,
</span></span><span style=display:flex><span>   kwargs<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;column&#34;</span>: <span style=color:#e6db74>&#34;varchar_column&#34;</span>}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>e4 <span style=color:#f92672>=</span> ExpectationConfiguration( <span style=color:#75715e># column「varchar_column」は&#39;xxxx&#39;か&#39;yyyy&#39;のvalueが入る。</span>
</span></span><span style=display:flex><span>   expectation_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;expect_column_values_to_be_in_set&#34;</span>,
</span></span><span style=display:flex><span>   kwargs<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;column&#34;</span>: <span style=color:#e6db74>&#34;varchar_column&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;value_set&#34;</span>: [<span style=color:#e6db74>&#39;xxxx&#39;</span>, <span style=color:#e6db74>&#39;yyyy&#39;</span>]}
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h4 id=expectationsuiteへexpectationの追加>ExpectationSuiteへExpectationの追加<a hidden class=anchor aria-hidden=true href=#expectationsuiteへexpectationの追加>#</a></h4><p>expectationをまとめて渡すexpectation_configurationsは、 version0.15.*から使えるみたい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>suite<span style=color:#f92672>.</span>add_expectation_configurations(
</span></span><span style=display:flex><span>    expectation_configurations<span style=color:#f92672>=</span>[e1,e2,e3,e4])
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>save_expectation_suite(suite, <span style=color:#e6db74>&#34;test_suite2&#34;</span>)
</span></span></code></pre></div><h4 id=validatorを作成しvalidateしてみる>Validatorを作成しValidateしてみる。<a hidden class=anchor aria-hidden=true href=#validatorを作成しvalidateしてみる>#</a></h4><p>batch_requestとexpectation_suiteの準備ができたので、Validatorを作成してValidateしてみる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>res <span style=color:#f92672>=</span> validator<span style=color:#f92672>.</span>validate()
</span></span></code></pre></div><h4 id=結果を表示してみる>結果を表示してみる。<a hidden class=anchor aria-hidden=true href=#結果を表示してみる>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> res[<span style=color:#e6db74>&#39;results&#39;</span>]:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;---&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;expectation_type: </span><span style=color:#e6db74>{</span>r<span style=color:#f92672>.</span>expectation_config<span style=color:#f92672>.</span>expectation_type<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;kwargs: </span><span style=color:#e6db74>{</span>r<span style=color:#f92672>.</span>expectation_config<span style=color:#f92672>.</span>kwargs<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;success: </span><span style=color:#e6db74>{</span>r<span style=color:#f92672>.</span>success<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;result: </span><span style=color:#e6db74>{</span>r<span style=color:#f92672>.</span>result<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span></code></pre></div><p>上記を実行すると以下のような実行結果が見える。</p><pre tabindex=0><code>---
expectation_type: expect_column_values_to_not_be_null
kwargs: {&#39;column&#39;: &#39;int_column&#39;, &#39;batch_id&#39;: &#39;b431836ba46465a1106559d8e5ff2656&#39;}
success: True
result: {&#39;element_count&#39;: 8, &#39;unexpected_count&#39;: 0, &#39;unexpected_percent&#39;: 0.0, &#39;partial_unexpected_list&#39;: []}
---
expectation_type: expect_column_values_to_be_between
kwargs: {&#39;column&#39;: &#39;int_column&#39;, &#39;max_value&#39;: 7, &#39;min_value&#39;: 0, &#39;batch_id&#39;: &#39;b431836ba46465a1106559d8e5ff2656&#39;}
success: True
result: {&#39;element_count&#39;: 8, &#39;unexpected_count&#39;: 0, &#39;unexpected_percent&#39;: 0.0, &#39;partial_unexpected_list&#39;: [], &#39;missing_count&#39;: 0, &#39;missing_percent&#39;: 0.0, &#39;unexpected_percent_total&#39;: 0.0, &#39;unexpected_percent_nonmissing&#39;: 0.0}
---
expectation_type: expect_column_values_to_not_be_null
kwargs: {&#39;column&#39;: &#39;varchar_column&#39;, &#39;batch_id&#39;: &#39;b431836ba46465a1106559d8e5ff2656&#39;}
success: True
result: {&#39;element_count&#39;: 8, &#39;unexpected_count&#39;: 0, &#39;unexpected_percent&#39;: 0.0, &#39;partial_unexpected_list&#39;: []}
---
expectation_type: expect_column_values_to_be_in_set
kwargs: {&#39;column&#39;: &#39;varchar_column&#39;, &#39;value_set&#39;: [&#39;xxxx&#39;, &#39;yyyy&#39;], &#39;batch_id&#39;: &#39;b431836ba46465a1106559d8e5ff2656&#39;}
success: True
result: {&#39;element_count&#39;: 8, &#39;unexpected_count&#39;: 0, &#39;unexpected_percent&#39;: 0.0, &#39;partial_unexpected_list&#39;: [], &#39;missing_count&#39;: 0, &#39;missing_percent&#39;: 0.0, &#39;unexpected_percent_total&#39;: 0.0, &#39;unexpected_percent_nonmissing&#39;: 0.0}
</code></pre><p>試しに以下の行を追加して、『2. column「int_column」は0~7のvalueである。』に反するようにしてみる。</p><ul><li>DDL</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> sample_poyo <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>9</span>, <span style=color:#e6db74>&#39;xxxx&#39;</span>, <span style=color:#e6db74>&#39;zzzz&#39;</span>);
</span></span></code></pre></div><ul><li>データ内容</li></ul><pre tabindex=0><code> int_column | varchar_column | varchar_column2 
------------+----------------+-----------------
         0 | xxxx           | zzzz
         1 | xxxx           | zzzz
         2 | xxxx           | zzzz
         3 | xxxx           | zzzz
         4 | yyyy           | zzzz
         5 | yyyy           | zzzz
         6 | yyyy           | zzzz
         7 | yyyy           | zzzz
         9 | yyyy           | zzzz
</code></pre><p>そうすると次のように結果が変わる。検証対象９行(element_count)のうち1行(unexpected_count)が期待通りではない、という意味だ。</p><pre tabindex=0><code>expectation_type: expect_column_values_to_be_between
kwargs: {&#39;column&#39;: &#39;int_column&#39;, &#39;max_value&#39;: 7, &#39;min_value&#39;: 0, &#39;batch_id&#39;: &#39;b431836ba46465a1106559d8e5ff2656&#39;}
success: False
result: {&#39;element_count&#39;: 9, &#39;unexpected_count&#39;: 1, &#39;unexpected_percent&#39;: 11.11111111111111, &#39;partial_unexpected_list&#39;: [9], &#39;missing_count&#39;: 0, &#39;missing_percent&#39;: 0.0, &#39;unexpected_percent_total&#39;: 11.11111111111111, &#39;unexpected_percent_nonmissing&#39;: 11.11111111111111}
</code></pre><h2 id=つまづいたポイント>つまづいたポイント<a hidden class=anchor aria-hidden=true href=#つまづいたポイント>#</a></h2><p>今回指定したように、SqlAlchemyを活用したDataSourceを作成したい場合(execution_engine.class_nameに<code>SqlAlchemyExecutionEngine</code>を指定したDataSourceの場合)、create_engineする時の引数は「connection_string」しか現在渡せないようです。
<a href=https://github.com/great-expectations/great_expectations/issues/6226>https://github.com/great-expectations/great_expectations/issues/6226</a></p><h2 id=終わりに>終わりに<a hidden class=anchor aria-hidden=true href=#終わりに>#</a></h2><p>GreatExpectationsとは何か、およびPythonを使った使い方について説明していきました。
今回は使いませんでしたがRuntimeBatchRequestを使えば検証したいデータを都度柔軟に指定できるところ、Queryを書かずにExpectationを定義できるところ、及びコードベースでそれらが管理できるところが個人的に良いかなと思っています。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://467tn.com/tags/greatexpectations/>GreatExpectations</a></li><li><a href=https://467tn.com/tags/python/>Python</a></li></ul><nav class=paginav><a class=prev href=https://467tn.com/post/content7/><span class=title>« Prev</span><br><span>AirflowのTaskFlowAPIについて</span></a>
<a class=next href=https://467tn.com/post/content5/><span class=title>Next »</span><br><span>デザイン変えました</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Great Expectationsについて調べてみた on twitter" href="https://twitter.com/intent/tweet/?text=Great%20Expectations%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%e8%aa%bf%e3%81%b9%e3%81%a6%e3%81%bf%e3%81%9f&url=https%3a%2f%2f467tn.com%2fpost%2fcontent6%2f&hashtags=GreatExpectations%2cPython"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://467tn.com>-1.9517320122461623</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerHTML="copy";function s(){e.innerHTML="copied!",setTimeout(()=>{e.innerHTML="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>